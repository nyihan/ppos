<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Myanmar POS Pro v88</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE STYLES --- */
        :root { 
            --primary: #2563eb; 
            --dark: #1e293b; 
            --text-gray: #64748b;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --glass-surface: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.9);
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg-gradient); 
            height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden; user-select: none; 
            color: var(--dark);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        /* --- ICONS --- */
        .icon { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 18px; height: 18px; stroke-width: 2.5; fill: none; stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; }

        /* --- NEW 3D FULL WIDTH NAVBAR --- */
        .navbar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 85px; /* Taller for pop-up */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px 30px 0 0; /* Top corners rounded */
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 10px; z-index: 2000; /* High z-index */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            border-top: 1px solid rgba(255,255,255,0.6);
        }

        .navbar button {
            border: none; background: transparent;
            width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .navbar button svg {
            width: 24px; height: 24px;
            stroke: currentColor; stroke-width: 2; fill: none;
            stroke-linecap: round; stroke-linejoin: round;
        }

        .navbar button span {
            font-size: 11px; font-weight: 700;
            display: none; position: absolute; bottom: -25px;
            white-space: nowrap; color: var(--primary);
        }

        .navbar button.active {
            color: var(--primary); background: #ffffff;
            /* Neumorphic 3D Shadow */
            box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.3), -6px -6px 12px rgba(255, 255, 255, 0.8);
            transform: translateY(-35px) scale(1.1); /* Pop up effect */
            border: 1px solid rgba(255,255,255,0.8);
        }

        .navbar button.active span { display: block; }

        .screen { display: none; flex-direction: column; height: 100%; position: relative; overflow: hidden; padding-bottom: 100px; /* Add padding for bottom bar */ }
        .active-screen { display: flex; }

        /* --- POS HEADER --- */
        .pos-header {
            flex-shrink: 0;
            padding: 10px 15px;
            z-index: 10;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            height: 60px;
        }
        .category-wrapper { flex: 1; overflow: hidden; display: flex; align-items: center; }
        .category-bar { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; width: 100%; }
        .cat-chip { 
            padding: 8px 16px; background: white; border-radius: 12px; 
            font-size: 13px; color: var(--text-gray); border: 1px solid #e2e8f0; 
            white-space: nowrap; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* SEARCH BOX */
        .search-wrapper { flex: 1; display: none; align-items: center; gap: 10px; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        
        .glass-search { 
            flex: 1; display: flex; align-items: center; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border: 1px solid #e2e8f0; border-radius: 14px; padding: 8px 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .search-input { border: none; background: transparent; width: 100%; outline: none; font-size: 16px; color: var(--dark); font-weight: 600; padding: 0; margin: 0; }
        .search-btn-icon { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            color: var(--dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; flex-shrink: 0;
        }

        /* --- PRODUCT GRID --- */
        .product-area { flex: 1; overflow-y: auto; padding: 10px 15px; padding-bottom: 180px; }
        .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .product-btn { 
            background: white; padding: 10px; text-align: center; border-radius: 16px; 
            min-height: 100px; display: flex; flex-direction: column; justify-content: center; 
            position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
        }
        .product-btn:active { transform: scale(0.96); background: #f8fafc; }
        .product-name { font-weight: 700; font-size: 12px; color: var(--dark); margin-bottom: 4px; height: 32px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .product-price { color: var(--primary); font-weight: 800; font-size: 13px; }
        .stock-badge { font-size: 9px; color: var(--text-gray); background: #f1f5f9; padding: 3px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; font-weight: 600; }
        .out-of-stock { opacity: 0.6; }
        .out-of-stock .stock-badge { color: #ef4444; background: #fee2e2; }
        .hot-badge { position:absolute; top:-5px; right:-5px; background:#ff7675; color:white; font-size:9px; font-weight:bold; padding:2px 8px; border-radius:10px; box-shadow: 0 2px 5px rgba(255,118,117,0.4); z-index: 2; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0); } }

        /* NEW: Cart Qty Badge on Item */
        .cart-qty-badge {
            position: absolute; top: -5px; left: -5px;
            background: var(--primary); color: white;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 800;
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
            z-index: 3; border: 2px solid white;
        }

        /* GLASS FAB SCANNER */
        .glass-fab {
            position: fixed; bottom: 110px; /* Adjusted for taller navbar */ right: 20px;
            width: 56px; height: 56px; border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer; color: var(--primary);
        }
        .glass-fab:active { transform: scale(0.9); }

        /* SLIDING CART */
        .cart-section {
            position: fixed; bottom: 85px; /* Adjusted for taller navbar */ left: 10px; width: calc(100% - 20px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            height: 60px; /* Collapsed */
            transition: height 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            z-index: 200; 
            border: 1px solid rgba(255,255,255,0.6);
        }
        .cart-section.expanded { height: 75vh; bottom: 10px; border-radius: 24px; z-index: 3000; }
        
        .cart-header { 
            height: 60px; padding: 0 20px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .cart-handle-bar { width: 40px; height: 5px; background: #dfe6e9; border-radius: 3px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .cart-summary-text { font-weight: 800; color: var(--dark); font-size: 15px; }
        .cart-total-badge { background: var(--dark); color: white; padding: 6px 12px; border-radius: 12px; font-weight: 700; font-size: 14px; }

        .cart-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
        .cart-section.expanded .cart-content { opacity: 1; }
        
        .cart-list { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .cart-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; margin-bottom: 8px;
            background: white; border-radius: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
        }
        .cart-footer { padding: 15px; background: white; border-top: 1px solid #f1f5f9; flex-shrink: 0; }
        .checkout-btn { 
            width: 100%; padding: 16px; 
            background: var(--dark); color: white; border: none; 
            border-radius: 16px; font-size: 18px; font-weight: 800; 
            display: flex; justify-content: center; align-items: center; gap: 10px; 
            box-shadow: 0 8px 20px rgba(30, 41, 59, 0.2); 
        }

        /* --- INVENTORY --- */
        .inventory-list { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; }
        .list-card { 
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 16px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center; 
        }
        
        .add-item-fab {
            position: fixed; bottom: 110px; /* Adjusted */ right: 20px;
            width: 56px; height: 56px; border-radius: 18px;
            background: var(--primary); color: white;
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; cursor: pointer;
        }

        /* --- HISTORY --- */
        .history-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 0 15px 100px 15px; /* Removed top padding to fix gap */
        }
        .date-header { 
            position: sticky; top: 0; 
            background: #e2e8f0; color: #475569; 
            padding: 6px 15px; border-radius: 0 0 8px 8px; /* Rounded only bottom */
            font-size: 12px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px;
            z-index: 10; margin-bottom: 2px; /* Decreased margin to fix gap */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .history-tabs { display: flex; gap: 10px; margin-bottom: 5px; /* Decreased margin */ }
        .tab-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; background: #e2e8f0; color: var(--text-gray); font-weight: 600; font-size: 13px; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* --- SOFT UI ACTION BUTTONS --- */
        .action-btn { 
            width: 38px; height: 38px; 
            border-radius: 12px; border: none; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.9); }
        .btn-edit { background: #e0e7ff; color: #4338ca; } 
        .btn-delete { background: #fee2e2; color: #ef4444; } 
        .btn-jpg { background: #dcfce7; color: #15803d; } 
        .btn-refund { background: #ffedd5; color: #c2410c; } 
        .btn-settle { background: #d1fae5; color: #047857; } 

        /* --- MODALS --- */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(30, 41, 59, 0.5); 
            z-index: 4000; /* Increased Z-Index to show above Expanded Cart */
            justify-content: center; align-items: center; backdrop-filter: blur(5px); 
        }
        .modal-box { background: white; padding: 25px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pay-input { width: 100%; padding: 15px; font-size: 28px; text-align: center; border: 2px solid #e2e8f0; border-radius: 16px; margin: 10px 0 20px 0; font-weight: 800; color: var(--dark); outline: none; background: #fff; }
        .pay-input:focus { border-color: var(--primary); }
        
        .quick-cash { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .chip { padding: 10px 14px; background: #f1f5f9; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; color: var(--text-gray); }
        .alert-btn { width: 100%; padding: 14px; background: var(--dark); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background: #f1f5f9; color: var(--dark); }
        .modal-input { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            border: 2px solid #e2e8f0; border-radius: 14px; 
            font-size: 15px; outline: none; box-sizing: border-box; background: #f8fafc;
        }

        /* --- 3D GLASS NUMBER PAD --- */
        .glass-numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        .numpad-btn {
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 16px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            cursor: pointer;
            box-shadow: 
                4px 4px 10px rgba(163, 177, 198, 0.2), 
                -4px -4px 10px rgba(255, 255, 255, 0.8);
            transition: all 0.1s ease;
            backdrop-filter: blur(5px);
        }
        .numpad-btn:active {
            transform: scale(0.95);
            box-shadow: inset 2px 2px 5px rgba(163, 177, 198, 0.2);
        }
        .numpad-btn.clr { color: var(--danger); }

        /* --- 3D GLASS VOUCHER MODAL STYLES --- */
        .glass-voucher-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.75), rgba(255,255,255,0.4));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 15px 35px rgba(31, 38, 135, 0.15);
            padding: 25px;
            width: 90%;
            max-width: 360px;
            color: #1e293b;
            text-align: left;
            animation: floatIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
        }
        @keyframes floatIn { from{opacity:0; transform:translateY(30px) scale(0.95);} to{opacity:1; transform:translateY(0) scale(1);} }
        
        .voucher-header { text-align: center; border-bottom: 2px dashed rgba(0,0,0,0.1); padding-bottom: 15px; margin-bottom: 15px; }
        .voucher-shop { font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: 0.5px; margin-bottom: 5px; }
        .voucher-meta { font-size: 11px; color: var(--text-gray); }
        
        .voucher-body { max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .v-item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid rgba(0,0,0,0.03); padding-bottom: 4px; }
        .v-item-name { font-weight: 600; color: var(--dark); }
        .v-item-sub { font-size: 11px; color: var(--text-gray); }
        
        .voucher-footer { background: rgba(255,255,255,0.5); border-radius: 16px; padding: 15px; border: 1px solid rgba(255,255,255,0.6); }
        .v-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .v-total { font-size: 16px; font-weight: 800; color: var(--dark); border-top: 1px dashed rgba(0,0,0,0.1); margin-top: 8px; padding-top: 8px; }
        
        .glass-btn {
            background: var(--dark); color: white;
            border: none; padding: 12px; border-radius: 14px;
            font-weight: 700; width: 100%; cursor: pointer;
            margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .glass-btn:active { transform: scale(0.98); }
        .glass-btn.secondary { background: white; color: var(--dark); border: 1px solid #e2e8f0; margin-top: 10px; }

        /* Minimal Sync Status */
        #sync-status { position: fixed; bottom: 120px; /* Adjusted */ left: 20px; width: 14px; height: 14px; z-index: 6000; }
        .dot { width: 100%; height: 100%; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.3s; }
        .synced .dot { background: #10b981; } .syncing .dot { background: #f59e0b; animation: pulse 1s infinite; } .error .dot { background: #ef4444; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        #sync-text { display: none; }

        /* Dashboard Styles Imported & Merged */
        .dash-container { overflow-y: auto; padding: 20px; padding-bottom: 100px; flex: 1; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* UPDATED DATE PICKER STYLES */
        .date-glass { 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 8px 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            width: auto;
        }
        .date-input { 
            border: none; 
            outline: none; 
            background: transparent; 
            font-family: 'Inter', sans-serif; 
            font-weight: 700; 
            font-size: 14px; 
            color: var(--dark); 
            text-align: center;
            width: 130px; 
            cursor: pointer;
            margin: 0; padding: 0;
        }

        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .glass-box { background: var(--glass-surface); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); backdrop-filter: blur(16px); border-radius: 20px; border: 1px solid var(--glass-border); padding: 16px; transition: transform 0.2s; }
        .glass-box:active { transform: scale(0.98); }
        .stat-card { display: flex; flex-direction: column; justify-content: center; }
        .stat-card.main { grid-column: span 2; background: white; }
        .stat-icon { width: 36px; height: 36px; background: #eff6ff; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; color: var(--primary); }
        .stat-label { font-size: 11px; font-weight: 700; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 20px; font-weight: 800; margin-top: 4px; color: var(--dark); }

        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .act-btn { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 15px 5px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: var(--dark); font-weight: 700; font-size: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .act-btn svg { width: 22px; height: 22px; color: var(--primary); }
        .act-btn:active { transform: scale(0.95); background: #f8fafc; }

        .list-section-title { font-size: 14px; font-weight: 700; margin: 15px 0 10px 5px; color: var(--dark); }
        .dash-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .dash-list-item:last-child { border-bottom: none; }
        .item-icon { width: 36px; height: 36px; border-radius: 10px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 18px; }
        
        .debt-card { background: white; padding: 14px; border-radius: 14px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-left: 4px solid var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
        .alert-item { display: flex; justify-content: space-between; align-items: center; background: #fffbeb; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #fcd34d; font-size: 13px; }
        .alert-item.critical { background: #fef2f2; border-color: #fecaca; }

        #toast { visibility: hidden; min-width: 250px; background-color: #2d3436; color: #fff; text-align: center; border-radius: 30px; padding: 12px 20px; position: fixed; z-index: 6000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; font-weight: 600; opacity: 0; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        #receipt-export { position: absolute; left: -9999px; background: white; padding: 20px; width: 300px; font-family: monospace; }
        #scanner-container { display: none; position: fixed; inset: 0; background: black; z-index: 3000; }
        #reader { width: 100%; height: 100%; }
        .close-scanner-btn { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.2); padding: 15px 30px; border-radius: 30px; color: white; border: 1px solid rgba(255,255,255,0.3); font-weight: 700; z-index: 3001; backdrop-filter: blur(5px); }
        
        .refund-item { background: #f8fafc; border-radius: 12px; padding: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .refund-qty-btn { background: #ffe4e6; color: #e11d48; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; }

        input, select { width: 100%; padding: 14px; margin-bottom: 12px; box-sizing: border-box; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; background: white; appearance: none; outline: none; }
    </style>
</head>
<body>

    <div id="sync-status" class="synced"><div class="dot"></div></div>
    <div id="toast">Press back again to exit</div>

    <!-- EXPORT TEMPLATE -->
    <div id="receipt-export">
        <div style="text-align:center; margin-bottom:10px;">
            <div id="r-exp-shop-name" style="font-weight:bold; font-size:18px;">MY SHOP</div>
            <div id="r-exp-shop-phone" style="font-size:12px;"></div>
        </div>
        <div style="border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:10px;">
            Date: <span id="r-exp-date"></span><br>
            ID: <span id="r-exp-id"></span>
        </div>
        <div id="r-exp-items"></div>
        <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px; text-align:right; font-weight:bold;">
            Total: <span id="r-exp-total"></span>
        </div>
        <div id="r-exp-footer" style="text-align:center; margin-top:15px; font-size:11px; font-style:italic;"></div>
    </div>

    <!-- MAIN POS -->
    <div id="pos-screen" class="screen active-screen">
        <div class="pos-header">
            <div id="category-wrapper" class="category-wrapper">
                <div class="category-bar" id="category-bar"></div>
            </div>
            <div id="search-wrapper" class="search-wrapper" style="display:none;">
                <div class="glass-search">
                    <svg class="icon" style="color:var(--text-gray); margin-right:8px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="live-search" class="search-input" placeholder="Search Item..." oninput="handleSearch(this.value)">
                    <span onclick="document.getElementById('live-search').value=''; handleSearch('')" style="color:#94a3b8; cursor:pointer;">‚úï</span>
                </div>
                <button class="search-btn-icon" onclick="toggleSearch(false)">‚úï</button>
            </div>
            <button id="search-toggle-btn" class="search-btn-icon" onclick="toggleSearch(true)">
                <svg class="icon" style="width:20px; height:20px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
        </div>

        <div class="product-area"><div id="product-list" class="product-grid"></div></div>
        
        <!-- FAB - Direct Scan -->
        <div class="glass-fab" onclick="startScanner('cart')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="2"/></svg>
        </div>

        <div class="cart-section" id="cart-section">
            <div class="cart-header" onclick="toggleCart()">
                <div class="cart-handle-bar"></div>
                <div class="cart-summary-text" style="display:flex; align-items:center; gap:8px;">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                    Current Sale
                </div>
                <div class="cart-total-badge" id="mini-cart-total">0 Ks</div>
            </div>
            
            <div class="cart-content">
                <div style="padding:10px 25px; display:flex; justify-content:flex-end;">
                    <div onclick="clearCartVerify()" style="color:#ef4444; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px; background: #fee2e2; padding: 8px 15px; border-radius: 12px;">
                        <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Clear
                    </div>
                </div>
                
                <div id="cart-items" class="cart-list"></div>
                
                <div class="cart-footer">
                    <button class="checkout-btn" onclick="openPaymentModal()">
                        <svg class="icon" style="color:white" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                        <span>CHARGE</span>
                        <span id="total-display">0 Ks</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-box" style="padding-bottom:15px;">
            <h2 style="margin:0; color:var(--dark); font-size:24px;">Total Due</h2>
            <div style="font-size:32px; font-weight:800; color:var(--primary); margin:5px 0;" id="pay-total">0 Ks</div>
            <input type="number" id="cash-input" class="pay-input" placeholder="Enter Amount" readonly onclick="this.value=''">
            
            <!-- 3D GLASS NUMBER PAD -->
            <div class="glass-numpad">
                <div class="numpad-btn" onclick="handleNumKey(1)">1</div>
                <div class="numpad-btn" onclick="handleNumKey(2)">2</div>
                <div class="numpad-btn" onclick="handleNumKey(3)">3</div>
                <div class="numpad-btn" onclick="handleNumKey(4)">4</div>
                <div class="numpad-btn" onclick="handleNumKey(5)">5</div>
                <div class="numpad-btn" onclick="handleNumKey(6)">6</div>
                <div class="numpad-btn" onclick="handleNumKey(7)">7</div>
                <div class="numpad-btn" onclick="handleNumKey(8)">8</div>
                <div class="numpad-btn" onclick="handleNumKey(9)">9</div>
                <div class="numpad-btn" onclick="handleNumKey('00')">00</div>
                <div class="numpad-btn" onclick="handleNumKey(0)">0</div>
                <div class="numpad-btn clr" onclick="handleNumKey('c')">C</div>
            </div>

            <!-- MODIFIED QUICK CASH SUGGESTIONS -->
            <div class="quick-cash">
                <div class="chip" onclick="fillCash(1000)">+1,000</div>
                <div class="chip" onclick="fillCash(3000)">+3,000</div>
                <div class="chip" onclick="fillCash(5000)">+5,000</div>
                <div class="chip" onclick="fillCash(10000)">+10,000</div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('payment-modal').style.display='none'" class="alert-btn btn-secondary">Cancel</button>
                <button onclick="processPayment()" class="alert-btn" style="background:var(--primary); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);">CONFIRM PAY</button>
            </div>
        </div>
    </div>

    <!-- DEBT MODAL -->
    <div id="debt-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#ef4444;">Partial Payment</h3>
            <div style="text-align:left; margin-bottom:15px; font-size:14px; color:#64748b;">
                <div>Total: <b id="debt-total"></b></div>
                <div>Paid: <b id="debt-paid"></b></div>
                <div style="color:#ef4444; margin-top:5px;">Remaining: <b id="debt-remain"></b></div>
            </div>
            <input type="text" id="debt-customer" placeholder="Customer Name" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; margin-bottom:15px;">
            <button onclick="confirmDebt()" class="alert-btn" style="background:#ef4444;">Save as Debt</button>
        </div>
    </div>

    <!-- NEW 3D GLASS VOUCHER MODAL -->
    <div id="glass-voucher-modal" class="modal-overlay" onclick="closeVoucher(event)">
        <div class="glass-voucher-box">
            <div class="voucher-header">
                <div class="voucher-shop" id="v-shop-name">MY SHOP</div>
                <div class="voucher-meta" id="v-shop-phone"></div>
                <div class="voucher-meta" id="v-date" style="margin-top:5px;"></div>
                <div class="voucher-meta" id="v-id"></div>
            </div>
            
            <div class="voucher-body" id="v-items">
                <!-- Item rows will go here -->
            </div>
            
            <div class="voucher-footer">
                <div class="v-row"><span>Subtotal</span><span id="v-subtotal"></span></div>
                <div class="v-row v-total"><span>Total</span><span id="v-total"></span></div>
                <div class="v-row" style="margin-top:5px; color:#64748b;"><span>Paid</span><span id="v-paid"></span></div>
                <div class="v-row" id="v-change-row" style="margin-top:5px;"><span>Change</span><span id="v-change"></span></div>
                <div id="v-footer-note" style="text-align:center; font-size:10px; font-style:italic; margin-top:10px; color:#94a3b8;"></div>
            </div>

            <button class="glass-btn" onclick="saveVoucherImage()">
                <svg class="icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Save as Image
            </button>
            <button class="glass-btn secondary" onclick="document.getElementById('glass-voucher-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- RECEIPT MODAL (For New Sales) -->
    <div id="receipt-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="width:70px; height:70px; background:#dcfce7; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto;">
                <svg class="icon" style="color:#16a34a; width:36px; height:36px;" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <h2 style="margin:0; font-size:22px;">Success</h2>
            <div style="margin-top:25px; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Total</span><span id="r-total" style="font-weight:bold;">0</span></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><span>Cash</span><span id="r-cash" style="font-weight:bold;">0</span></div>
            </div>
            <div style="background:#f8fafc; padding:20px; border-radius:20px; border: 1px dashed #cbd5e1;">
                <div style="color:var(--text-gray); font-size:12px; font-weight:700; text-transform:uppercase;">Change</div>
                <div id="r-change" style="font-size:32px; color:var(--dark); font-weight:900;">0</div>
            </div>
            <button onclick="closeReceipt()" class="alert-btn">Next Sale</button>
        </div>
    </div>

    <!-- REFUND MODAL -->
    <div id="refund-modal" class="modal-overlay" onclick="closeRefundModal(event)">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--dark);">Refund Item</h3>
            <div id="refund-list" style="max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px;"></div>
            <button onclick="document.getElementById('refund-modal').style.display='none'" class="alert-btn btn-secondary">Close</button>
        </div>
    </div>

    <!-- INVENTORY SCREEN -->
    <div id="inventory-screen" class="screen">
        <div class="sticky-header" style="padding:20px; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); z-index:20; border-bottom:1px solid #f1f5f9;"><h3 style="margin:0;">Inventory</h3></div>
        <div id="inventory-list" class="inventory-list"></div>
        <div class="add-item-fab" onclick="openProductModal()">
            <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </div>
    </div>

    <!-- ADD PRODUCT MODAL -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">Manage Item</h3>
            <input type="hidden" id="edit-index" value="-1">
            <select id="new-category" style="width:100%;"><option>General</option><option>Drinks</option><option>Food</option><option>Snacks</option></select>
            <input type="text" id="new-name" placeholder="Item Name">
            <div style="display:flex; gap:10px;">
                <input type="number" id="new-price" placeholder="Price" style="flex:2" oninput="autoCalcCost()">
                <input type="number" id="new-stock" placeholder="Stock" style="flex:1">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                 <input type="number" id="new-discount" placeholder="Disc %" style="flex:1" oninput="autoCalcCost()">
                 <input type="number" id="new-cost" placeholder="Buying Price (Cost)" style="flex:2">
            </div>
            
            <!-- NEW WHOLESALE FIELDS -->
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="number" id="new-pack-count" placeholder="Pack Qty (e.g. 12)" style="flex:1">
                <input type="number" id="new-pack-price" placeholder="Pack Price" style="flex:1">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="new-code" placeholder="Barcode" style="flex:2">
                <button onclick="startScanner('new-code')" style="flex:1; background:#f1f5f9; border:none; border-radius:12px;">üì∑</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="document.getElementById('product-modal').style.display='none'" class="alert-btn btn-secondary">Cancel</button>
                <button onclick="saveProduct()" class="alert-btn" style="background:var(--dark);">Save</button>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="history-screen" class="screen">
        <div class="sticky-header" style="flex-direction:column; align-items:stretch; gap:10px; padding:20px 20px 5px 20px; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); z-index:20; border-bottom:1px solid #f1f5f9;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">History</h3>
                <button onclick="fetchServerData(true)" style="background:#eff6ff; color:var(--primary); border:none; padding:8px 12px; border-radius:8px; font-weight:700; font-size:12px;">Sync</button>
            </div>
            <div class="history-tabs">
                <button class="tab-btn active" onclick="filterHistory('all')" id="tab-all">All</button>
                <button class="tab-btn" onclick="filterHistory('paid')" id="tab-paid">Paid</button>
                <button class="tab-btn" onclick="filterHistory('unpaid')" id="tab-unpaid" style="color:#ef4444;">Unpaid</button>
            </div>
        </div>
        <div id="history-list" class="history-list"></div>
    </div>

    <!-- DASHBOARD SCREEN (MERGED & ENHANCED) -->
    <div id="dashboard-screen" class="screen">
        <div class="dash-container">
            <!-- Header with Date Picker -->
            <div class="dash-header">
                <h3 style="margin:0;">Dashboard</h3>
                <div class="date-glass">
                    <input type="date" class="date-input" id="date-picker">
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stat-grid">
                <!-- Sales -->
                <div class="glass-box stat-card main">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="stat-label">Total Sales</div>
                            <div class="stat-value" id="stat-sales">0 Ks</div>
                        </div>
                        <div class="stat-icon" style="background:#eff6ff; color:#2563eb;">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Expense -->
                <div class="glass-box stat-card">
                    <div class="stat-label">Expense</div>
                    <div class="stat-value" style="color:#b45309;" id="stat-expense">0 Ks</div>
                </div>

                <!-- Net Profit -->
                <div class="glass-box stat-card">
                    <div class="stat-label">Net Profit</div>
                    <div class="stat-value" style="color:#059669;" id="stat-profit">0 Ks</div>
                </div>

                <!-- Debt -->
                <div class="glass-box stat-card" onclick="document.getElementById('debt-section').scrollIntoView({behavior:'smooth'})">
                    <div class="stat-label">Total Debt (All Time)</div>
                    <div class="stat-value" style="color:#ef4444;" id="stat-debt">0 Ks</div>
                </div>
            </div>

            <!-- Action Grid -->
            <div class="action-grid">
                <div class="act-btn" onclick="document.getElementById('expense-modal').style.display='flex'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#ef4444;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <span>Add Expense</span>
                </div>
                <div class="act-btn" onclick="backupData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>Backup</span>
                </div>
                <div class="act-btn" onclick="restoreData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>Restore</span>
                </div>
            </div>

            <!-- Sections -->
            <div id="debt-section" style="display:none; margin-bottom: 20px;">
                <div class="list-section-title" style="color:#ef4444;">Outstanding Debts</div>
                <div id="debt-list"></div>
            </div>
            
            <div class="list-section-title">‚ö†Ô∏è Low Stock Alert (Below 5)</div>
            <div class="glass-box" style="padding:10px" id="low-stock-list"></div>

            <div class="list-section-title">Top Selling (Selected Date)</div>
            <div class="glass-box" style="padding:0 20px;" id="top-selling-list"></div>

            <div class="list-section-title">Recent Expenses</div>
            <div class="glass-box" style="padding:0 20px;" id="expense-list"></div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="settings-screen" class="screen">
        <div class="sticky-header" style="padding:20px; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); z-index:20; border-bottom:1px solid #f1f5f9;"><h3 style="margin:0;">Settings</h3></div>
        <div class="settings-container" style="padding:20px;">
            
            <!-- SHOP INFO -->
            <div class="setting-group" style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label class="setting-label" style="display:block; margin-bottom:10px; font-weight:700;">Shop Name</label>
                <input type="text" id="shop-name" class="modal-input" placeholder="My Shop">
                
                <label class="setting-label" style="display:block; margin-bottom:10px; font-weight:700;">Phone</label>
                <input type="text" id="shop-phone" class="modal-input" placeholder="09xxxxxxxxx">
                
                <label class="setting-label" style="display:block; margin-bottom:10px; font-weight:700;">Footer</label>
                <input type="text" id="shop-footer" class="modal-input" placeholder="Thank you!">
                
                <button onclick="saveShopInfo()" class="alert-btn" style="width:100%; margin-top:5px; background:var(--primary);">Save Info</button>
            </div>

            <!-- DATE FORMAT -->
            <div class="setting-group" style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label class="setting-label" style="display:block; margin-bottom:10px; font-weight:700;">Date Format</label>
                <select id="date-format-select" onchange="saveDateFormat(this.value)" style="margin-bottom:0;">
                    <option value="YYYY-MM-DD">YYYY-MM-DD (Default)</option>
                    <option value="DD/MM/YYYY">DD/MM/YYYY (Day/Month/Year)</option>
                    <option value="MM/DD/YYYY">MM/DD/YYYY (Month/Day/Year)</option>
                    <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                </select>
            </div>

            <div class="setting-group" style="background:white; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                <label class="setting-label" style="display:block; margin-bottom:10px; font-weight:700;">Database</label>
                <button onclick="if(confirm('Reset all?')) { localStorage.clear(); location.reload(); }" class="alert-btn" style="background:#fee2e2; color:#ef4444; margin-top:0;">Reset App Data</button>
            </div>
        </div>
    </div>

    <!-- COMMON MODALS -->
    <div id="custom-alert" class="modal-overlay" onclick="closeAlert()"><div class="modal-box"><h3 id="alert-title">Notice</h3><p id="alert-message" style="color:var(--text-gray)"></p><button onclick="closeAlert()" class="alert-btn">OK</button></div></div>
    <div id="custom-confirm" class="modal-overlay"><div class="modal-box"><h3>Confirm</h3><p id="confirm-message" style="color:var(--text-gray)"></p><div class="confirm-actions"><button onclick="closeConfirm()" class="alert-btn btn-secondary">No</button><button id="confirm-yes-btn" class="alert-btn" style="background:var(--primary)">Yes</button></div></div></div>
    
    <!-- EXPENSE MODAL -->
    <div id="expense-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">Add Expense</h3>
            <input type="text" id="exp-title" class="modal-input" placeholder="Title (e.g. ·Äô·ÄÆ·Ä∏·Äñ·Ä≠·ÄØ·Ä∏)">
            <input type="number" id="exp-amount" class="modal-input" placeholder="Amount (e.g. 5000)">
            <div style="display:flex; gap:10px;">
                <button class="alert-btn btn-secondary" onclick="document.getElementById('expense-modal').style.display='none'">Cancel</button>
                <button class="alert-btn" onclick="saveExpense()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- SCANNER MODAL REMOVED - DIRECT ACCESS -->
    <div id="scan-choice-modal" class="modal-overlay" style="display:none;"></div> 

    <div id="scanner-container"><div id="reader"></div><button class="close-scanner-btn" onclick="stopScanner()">Close Camera</button></div>
    
    <!-- HIDDEN FILE INPUT FOR RESTORE -->
    <input type="file" id="restore-file" style="display:none" onchange="processRestore(this)">

    <!-- NEW 3D FULL WIDTH NAVBAR -->
    <div class="navbar">
        <button onclick="showScreen('dashboard')" id="btn-dash">
            <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
            <span>Dash</span>
        </button>
        <button onclick="showScreen('pos')" id="btn-pos">
            <svg class="icon" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            <span>Sell</span>
        </button>
        <button onclick="showScreen('inventory')" id="btn-inv">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
            <span>Items</span>
        </button>
        <button onclick="showScreen('history')" id="btn-hist">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span>History</span>
        </button>
        <button onclick="showScreen('settings')" id="btn-set">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span>Set</span>
        </button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX0aG1RfowaxXfHPNaPgxYSzQyL1wRnA78S0F3ZSpUiP-NA2CLIDBDuq1utof4DWX3/exec"; 
        // INCREASE FETCH INTERVAL TO REDUCE SERVER LOAD
        const FETCH_INTERVAL = 60000; 

        let products = JSON.parse(localStorage.getItem('myShopProducts')) || [];
        let salesHistory = JSON.parse(localStorage.getItem('myShopHistory')) || [];
        let expenses = JSON.parse(localStorage.getItem('myShopExpenses')) || [];
        
        // Fix: Initialize clearly to prevent undefined issues
        let savedSettings = JSON.parse(localStorage.getItem('myShopSettings'));
        let appSettings = {
            name: (savedSettings && savedSettings.name) ? savedSettings.name : "",
            phone: (savedSettings && savedSettings.phone) ? savedSettings.phone : "",
            footer: (savedSettings && savedSettings.footer) ? savedSettings.footer : "",
            dateFormat: (savedSettings && savedSettings.dateFormat) ? savedSettings.dateFormat : "YYYY-MM-DD"
        };
        
        let cart = [];
        let currentFilter = 'All';
        let historyFilter = 'all';
        let scanner;
        let tempDebtSale = {};
        let currentVoucherId = null; 

        // --- QUEUE SYSTEM INIT ---
        let syncQueue = JSON.parse(localStorage.getItem('myShopQueue')) || [];

        // DATE FILTER INIT
        const dateInput = document.getElementById('date-picker');
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
        dateInput.addEventListener('change', renderDashboard);

        function loadSettings() {
            const select = document.getElementById('date-format-select');
            if(appSettings.dateFormat) select.value = appSettings.dateFormat;
            
            document.getElementById('shop-name').value = appSettings.name || '';
            document.getElementById('shop-phone').value = appSettings.phone || '';
            document.getElementById('shop-footer').value = appSettings.footer || '';
        }

        function saveDateFormat(val) {
            appSettings.dateFormat = val;
            localStorage.setItem('myShopSettings', JSON.stringify(appSettings));
            renderHistory();
            renderDashboard();
            showAlert("Date Format Saved!");
            
            // Queue Save
            addToSyncQueue("SAVE_SETTINGS", [appSettings.name, appSettings.phone, appSettings.footer, appSettings.dateFormat]);
        }
        
        function saveShopInfo() {
            const sName = document.getElementById('shop-name').value;
            const sPhone = document.getElementById('shop-phone').value;
            const sFooter = document.getElementById('shop-footer').value;

            appSettings.name = sName;
            appSettings.phone = sPhone;
            appSettings.footer = sFooter;
            
            localStorage.setItem('myShopSettings', JSON.stringify(appSettings));
            showAlert("Shop Info Saved!");
            
            // Queue Save
            addToSyncQueue("SAVE_SETTINGS", [sName, sPhone, sFooter, appSettings.dateFormat]);
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            try {
                let cleanDate = dateStr.replace('T', ' '); 
                const parts = cleanDate.split(' ');
                const datePart = parts[0];
                const timePart = parts[1] ? parts[1].split('.')[0] : ""; 
                
                const [y, m, d] = datePart.split('-');
                const fmt = appSettings.dateFormat;

                let formattedDate = datePart;
                if (fmt === 'DD/MM/YYYY') formattedDate = `${d}/${m}/${y}`;
                if (fmt === 'MM/DD/YYYY') formattedDate = `${m}/${d}/${y}`;
                if (fmt === 'DD-MM-YYYY') formattedDate = `${d}-${m}-${y}`;

                return timePart ? `${formattedDate} ${timePart}` : formattedDate;
            } catch (e) { return dateStr; }
        }

        // ... [SEARCH LOGIC KEPT SAME] ...
        function toggleSearch(show) {
            const catWrapper = document.getElementById('category-wrapper');
            const searchWrapper = document.getElementById('search-wrapper');
            const searchBtn = document.getElementById('search-toggle-btn');
            const input = document.getElementById('live-search');

            if (show) {
                catWrapper.style.display = 'none';
                searchBtn.style.display = 'none';
                searchWrapper.style.display = 'flex';
                input.focus();
            } else {
                searchWrapper.style.display = 'none';
                catWrapper.style.display = 'flex';
                searchBtn.style.display = 'flex';
                input.value = '';
                handleSearch('');
            }
        }

        function handleSearch(query) {
            const term = query.toLowerCase();
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.code.includes(term)
            );

            let salesCount = {};
            salesHistory.forEach(s => {
                if (s.items && typeof s.items === 'string') {
                    s.items.split(', ').forEach(item => {
                        let parts = item.split('x ');
                        if (parts.length > 1) {
                            let nameParts = parts[1].split(' (');
                            if (nameParts.length > 0) {
                                let name = nameParts[0];
                                let qty = parseInt(parts[0]);
                                if (!isNaN(qty)) {
                                    salesCount[name] = (salesCount[name] || 0) + qty;
                                }
                            }
                        }
                    });
                }
            });

            filtered.forEach(p => {
                let stockClass = p.stock<=0 ? 'out-of-stock' : '';
                let hotBadge = ((salesCount[p.name] || 0) > 5) ? `<span class="hot-badge">üî• Hot</span>` : '';
                let cartItem = cart.find(c => c.code === p.code);
                let cartQty = cartItem ? cartItem.qty : 0;
                let displayStock = p.stock - cartQty;
                let cartBadge = cartQty > 0 ? `<span class="cart-qty-badge">${cartQty}</span>` : '';
                
                if(displayStock <= 0) stockClass = 'out-of-stock';

                list.innerHTML += `
                <div class="product-btn ${stockClass}" onclick="addToCart('${p.code}')">
                    ${hotBadge}
                    ${cartBadge}
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price.toLocaleString()}</div>
                    <div class="stock-badge">Stock: ${displayStock}</div>
                </div>`;
            });
        }
        
        async function autoFillProductName(barcode) {
             try {
                if (products.some(p => p.code === barcode)) { showAlert("Item already exists ‚ö†Ô∏è"); return; }
                showToast("Searching product...");
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await res.json();
                if (data.status === 1) {
                    const name = data.product.product_name_en || data.product.product_name || "";
                    if (name) {
                        const nameInput = document.getElementById("new-name");
                        if(nameInput) { nameInput.value = name; showToast("Product Found: " + name); }
                    } else { showToast("Name unavailable"); }
                } else { showToast("Product not found online"); }
            } catch (e) { console.error(e); }
        }

        // ... [BACK LOGIC KEPT SAME] ...
        let lastBackPressTime = 0;
        history.pushState(null, null, location.href); 
        window.onpopstate = function(event) {
            const now = new Date().getTime();
            const openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
            if (openModal) { openModal.style.display = 'none'; history.pushState(null, null, location.href); return; }
            const cart = document.getElementById('cart-section');
            if (cart.classList.contains('expanded')) { cart.classList.remove('expanded'); history.pushState(null, null, location.href); return; }
            if (document.getElementById('search-wrapper').style.display === 'flex') { toggleSearch(false); history.pushState(null, null, location.href); return; }
            const active = document.querySelector('.screen.active-screen');
            if (active && active.id !== 'pos-screen') { showScreen('pos'); history.pushState(null, null, location.href); return; }
            if (now - lastBackPressTime < 2000) { } else { lastBackPressTime = now; history.pushState(null, null, location.href); showToast("Press back again to exit"); }
        };
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // ... [UI FUNCTIONS KEPT SAME] ...
        function toggleCart() { document.getElementById('cart-section').classList.toggle('expanded'); }
        function openPaymentModal() { if(cart.length === 0) return showAlert("Empty"); document.getElementById('pay-total').innerText = cart.reduce((a, b) => a + calculateItemTotal(b), 0).toLocaleString() + " Ks"; document.getElementById('cash-input').value = ''; document.getElementById('payment-modal').style.display = 'flex'; }
        function fillCash(a) { const i = document.getElementById('cash-input'); i.value = (parseInt(i.value)||0) + a; }
        
        function handleNumKey(key) {
            if (navigator.vibrate) navigator.vibrate(50);
            const input = document.getElementById('cash-input');
            if (key === 'c') { input.value = ''; } else { input.value = (input.value || '') + key; }
        }

        function processPayment() {
            if (navigator.vibrate) navigator.vibrate(50);
            const total = cart.reduce((a, b) => a + calculateItemTotal(b), 0);
            const cashInput = document.getElementById('cash-input').value;
            const cash = cashInput === '' ? 0 : parseFloat(cashInput);

            if (cash < total) {
                tempDebtSale = { total: total, cash: cash, debt: total - cash };
                document.getElementById('payment-modal').style.display = 'none';
                document.getElementById('debt-total').innerText = total.toLocaleString();
                document.getElementById('debt-paid').innerText = cash.toLocaleString();
                document.getElementById('debt-remain').innerText = tempDebtSale.debt.toLocaleString();
                document.getElementById('debt-customer').value = "";
                document.getElementById('debt-modal').style.display = 'flex';
                document.getElementById('debt-customer').focus();
            } else {
                completeSale(total, cash, 0, 'Paid', '');
            }
        }

        function confirmDebt() {
            if (navigator.vibrate) navigator.vibrate(50);
            const customer = document.getElementById('debt-customer').value;
            if(!customer) return alert("Name Required");
            document.getElementById('debt-modal').style.display = 'none';
            completeSale(tempDebtSale.total, tempDebtSale.cash, tempDebtSale.debt, 'Unpaid', customer);
        }

        function completeSale(total, cash, debt, status, customer) {
            document.getElementById('payment-modal').style.display = 'none';
            
            // Deduct stock
            cart.forEach(item => { let p = products.find(prod => prod.code === item.code); if(p) p.stock -= item.qty; });
            localStorage.setItem('myShopProducts', JSON.stringify(products));

            // Record Sale
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()+1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            const dateStr = `${yyyy}-${mm}-${dd} ${now.toLocaleTimeString()}`; 
            
            let itemStr = cart.map(i => `${i.qty}x ${i.name} (${calculateItemTotal(i).toLocaleString()})`).join(", ");
            const saleId = Date.now();
            
            const saleData = { id: saleId, date: dateStr, total: total, items: itemStr, paid: cash, debt: debt, status: status, customer: customer };
            salesHistory.unshift(saleData);
            localStorage.setItem('myShopHistory', JSON.stringify(salesHistory));

            renderDashboard(); renderPOS(); renderInventory(); renderHistory(); 
            
            // --- NEW: ROW-LEVEL SYNC WITH QUEUE ---
            // Update Products Stocks
            cart.forEach(item => {
               const p = products.find(prod => prod.code === item.code);
               if(p) addToSyncQueue("UPSERT_PRODUCT", [p.name, p.price, p.stock, p.code, p.category, p.cost]);
            });
            // Add Sale Record
            addToSyncQueue("ADD_SALE", [saleId, dateStr, total, itemStr, cash, debt, status, customer]);

            if(status === 'Paid') {
                const change = cash - total;
                document.getElementById('r-total').innerText = total.toLocaleString() + " Ks";
                document.getElementById('r-cash').innerText = cash.toLocaleString() + " Ks";
                document.getElementById('r-change').innerText = change.toLocaleString();
                document.getElementById('receipt-modal').style.display = 'flex';
            } else { showAlert("Debt Recorded"); }
            
            cart = []; updateCartUI();
            document.getElementById('cart-section').classList.remove('expanded');
        }

        function filterHistory(type) {
            historyFilter = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + type).classList.add('active');
            renderHistory();
        }

        function settleDebt(id) {
            event.stopPropagation(); 
            showConfirm("Mark as Paid?", () => {
                const sale = salesHistory.find(s => s.id === id);
                if(sale) {
                    sale.status = 'Paid';
                    sale.paid = sale.total;
                    sale.debt = 0;
                    localStorage.setItem('myShopHistory', JSON.stringify(salesHistory));
                    renderHistory(); renderDashboard();
                    
                    // Sync Update via Queue
                    addToSyncQueue("UPDATE_SALE", [sale.id, sale.date, sale.total, sale.items, sale.paid, sale.debt, sale.status, sale.customer]);
                }
            });
        }

        // ... [RENDER HISTORY KEPT SAME] ...
        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            let filtered = salesHistory;
            if(historyFilter === 'paid') filtered = salesHistory.filter(s => s.status === 'Paid');
            if(historyFilter === 'unpaid') filtered = salesHistory.filter(s => s.status === 'Unpaid');
            let groups = {};
            
            filtered.forEach(s => { 
                let cleanD = s.date.replace('T', ' ').split(' ')[0];
                let dFormatted = formatDate(cleanD);
                if(!groups[dFormatted]) groups[dFormatted]=[]; 
                groups[dFormatted].push(s); 
            });
            
            for(let d in groups) {
                list.innerHTML += `<div class="date-header">${d}</div>` + groups[d].map(s => {
                    let isDebt = s.status === 'Unpaid';
                    let displayDate = formatDate(s.date).split(' ')[1] || s.date;
                    let debtHtml = isDebt ? `<div style="margin-top:5px; color:#ef4444; font-weight:bold;">${s.customer}: ${s.debt.toLocaleString()} left</div>` : '';
                    let actionBtn = isDebt ? `<button onclick="settleDebt(${s.id})" class="action-btn btn-settle"><svg class="icon-sm" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg></button>` : ``;
                    
                    return `<div class="list-card" style="${isDebt?'border-left: 5px solid #ef4444; background: #fff1f2;':''}" onclick="viewVoucher(${s.id})">
                        <div style="flex:1">
                            <div><strong>${s.total.toLocaleString()}</strong> <span class="${isDebt ? 'debt-tag' : 'paid-tag'}">${isDebt ? 'UNPAID' : 'PAID'}</span></div>
                            <small>${displayDate}</small>
                            <div style="font-size:12px;color:#666;">${s.items.substring(0,30)}...</div>
                            ${debtHtml}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;">
                            ${actionBtn}
                            <button onclick="event.stopPropagation(); openRefundModal(${s.id})" class="action-btn btn-refund"><svg class="icon-sm" viewBox="0 0 24 24"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg></button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // ... [VOUCHER LOGIC KEPT SAME] ...
        function viewVoucher(id) {
            currentVoucherId = id;
            const sale = salesHistory.find(s => s.id === id);
            if (!sale) return;

            document.getElementById('v-shop-name').innerText = appSettings.name || 'MY SHOP';
            document.getElementById('v-shop-phone').innerText = appSettings.phone || '';
            document.getElementById('v-footer-note').innerText = appSettings.footer || '';

            document.getElementById('v-date').innerText = formatDate(sale.date);
            document.getElementById('v-id').innerText = '#' + sale.id.toString().slice(-6);
            
            const itemsContainer = document.getElementById('v-items');
            itemsContainer.innerHTML = '';
            
            if(sale.items) {
                sale.items.split(', ').forEach(itemStr => {
                    const parts = itemStr.split('x ');
                    if(parts.length > 1) {
                        const qty = parts[0];
                        let rest = parts[1];
                        let priceMatch = rest.match(/\(([^)]+)\)/);
                        let totalPrice = priceMatch ? priceMatch[1] : '';
                        let name = rest.split(' (')[0];
                        
                        itemsContainer.innerHTML += `
                        <div class="v-item-row">
                            <div style="flex:2">
                                <div class="v-item-name">${name}</div>
                                <div class="v-item-sub">Qty: ${qty}</div>
                            </div>
                            <div style="font-weight:700;">${totalPrice}</div>
                        </div>`;
                    }
                });
            }

            document.getElementById('v-subtotal').innerText = sale.total.toLocaleString();
            document.getElementById('v-total').innerText = sale.total.toLocaleString() + ' Ks';
            document.getElementById('v-paid').innerText = sale.paid.toLocaleString();
            
            const changeRow = document.getElementById('v-change-row');
            const changeEl = document.getElementById('v-change');
            
            if(sale.status === 'Unpaid') {
                changeRow.querySelector('span').innerText = 'Remaining Debt';
                changeEl.innerText = sale.debt.toLocaleString();
                changeEl.style.color = 'var(--danger)';
            } else {
                changeRow.querySelector('span').innerText = 'Change';
                changeEl.innerText = (sale.paid - sale.total).toLocaleString();
                changeEl.style.color = 'var(--dark)';
            }

            document.getElementById('glass-voucher-modal').style.display = 'flex';
        }

        function closeVoucher(e) { if(!e || e.target.id === 'glass-voucher-modal') document.getElementById('glass-voucher-modal').style.display = 'none'; }
        function saveVoucherImage() {
            document.getElementById('r-exp-shop-name').innerText = appSettings.name || 'MY SHOP';
            document.getElementById('r-exp-shop-phone').innerText = appSettings.phone || '';
            document.getElementById('r-exp-footer').innerText = appSettings.footer || '';
            if(currentVoucherId) saveReceiptImage(currentVoucherId);
        }

        // ... [DASHBOARD RENDERER KEPT SAME] ...
        function renderDashboard() {
            const selectedDate = document.getElementById('date-picker').value; 
            let daySalesTotal = 0;
            let dayProfitTotal = 0;
            let dayExpenseTotal = 0;

            const daySales = salesHistory.filter(s => s.date.startsWith(selectedDate));
            daySales.forEach(s => {
                if (s.status === 'Paid') {
                    daySalesTotal += s.total;
                    let cost = 0;
                    if(s.items) {
                        s.items.split(', ').forEach(i => {
                            const parts = i.split('x '); 
                            if (parts.length > 1) {
                                const qty = parseInt(parts[0]);
                                let namePart = parts[1].split(' (')[0].trim();
                                const product = products.find(p => p.name === namePart);
                                if(product) cost += (product.cost || 0) * qty;
                            }
                        });
                    }
                    dayProfitTotal += (s.total - cost);
                }
            });

            const dayExps = expenses.filter(e => e.date === selectedDate);
            dayExps.forEach(e => dayExpenseTotal += e.amount);
            const netProfit = dayProfitTotal - dayExpenseTotal;

            document.getElementById('stat-sales').innerText = daySalesTotal.toLocaleString() + ' Ks';
            document.getElementById('stat-expense').innerText = '- ' + dayExpenseTotal.toLocaleString() + ' Ks';
            const profitEl = document.getElementById('stat-profit');
            profitEl.innerText = (netProfit >= 0 ? '+ ' : '- ') + Math.abs(netProfit).toLocaleString() + ' Ks';
            profitEl.style.color = netProfit >= 0 ? '#10b981' : '#ef4444';

            const allDebts = salesHistory.filter(s => s.status === 'Unpaid');
            let debtTotal = 0;
            allDebts.forEach(d => debtTotal += d.debt);
            document.getElementById('stat-debt').innerText = debtTotal.toLocaleString() + ' Ks';

            renderRecentExpenses(dayExps);
            renderTopSelling(daySales);
            renderLowStock();
            renderDebts(allDebts);
        }

        function renderLowStock() {
            const list = document.getElementById('low-stock-list');
            const lowItems = products.filter(p => p.stock <= 5);
            list.innerHTML = lowItems.length ? '' : '<div style="padding:15px; text-align:center; color:#64748b; font-size:12px;">Stock is healthy!</div>';
            lowItems.forEach(p => {
                const isCritical = p.stock <= 2;
                list.innerHTML += `<div class="alert-item ${isCritical ? 'critical' : ''}"><div style="font-weight:700; color:${isCritical?'#b91c1c':'#b45309'};">${p.name}</div><div style="font-weight:800; color:${isCritical?'#ef4444':'#f59e0b'};">${p.stock} Left</div></div>`;
            });
        }

        function renderDebts(allDebts) {
            const list = document.getElementById('debt-list');
            const section = document.getElementById('debt-section');
            list.innerHTML = '';
            if(allDebts.length === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                allDebts.forEach(d => {
                    list.innerHTML += `<div class="debt-card" onclick="viewVoucher(${d.id})"><span style="font-weight:700;">${d.customer}</span><div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="color:#ef4444; font-weight:700;">${d.debt.toLocaleString()} Ks</span><span style="font-size:11px; color:#94a3b8;">${formatDate(d.date).split(' ')[0]}</span></div></div>`;
                });
            }
        }

        function renderTopSelling(dayData) {
             const list = document.getElementById('top-selling-list');
             let counts = {};
             dayData.forEach(s => {
                 if(s.status === 'Paid' && s.items) {
                     s.items.split(', ').forEach(i => {
                         const parts = i.split('x ');
                         if(parts.length > 1) {
                             const qty = parseInt(parts[0]);
                             const name = parts[1].split(' (')[0].trim();
                             counts[name] = (counts[name] || 0) + qty;
                         }
                     });
                 }
             });
             
             const sorted = Object.keys(counts).map(k => ({name:k, qty:counts[k]})).sort((a,b)=>b.qty-a.qty).slice(0,5);
             list.innerHTML = sorted.length ? '' : '<div style="text-align:center;color:#64748b;padding:10px; font-size:12px;">No sales yet today.</div>';
             
             sorted.forEach(item => {
                 const p = products.find(prod => prod.name === item.name);
                 const price = p ? p.price : 0;
                 list.innerHTML += `<div class="dash-list-item"><div style="display:flex; align-items:center;"><div class="item-icon">‚ö°</div><div><div style="font-weight:700; font-size:13px;">${item.name}</div><small style="color:#64748b;">${item.qty} Sold</small></div></div><div style="font-weight:700; font-size:13px;">${(price * item.qty).toLocaleString()} Ks</div></div>`;
             });
        }

        function renderRecentExpenses(listData) {
            const list = document.getElementById('expense-list');
            list.innerHTML = listData.length ? '' : '<div style="text-align:center;color:#64748b;padding:10px; font-size:12px;">No expenses added today.</div>';
            listData.forEach(e => {
                list.innerHTML += `<div class="dash-list-item"><div style="display:flex; align-items:center;"><div class="item-icon" style="color:#ef4444; background:rgba(239,68,68,0.1);">üí∏</div><div style="font-weight:700; font-size:13px;">${e.title}</div></div><div style="color:#ef4444; font-weight:700; font-size:13px;">- ${e.amount.toLocaleString()} Ks</div></div>`;
            });
        }

        function saveExpense() {
            const title = document.getElementById('exp-title').value;
            const amount = parseInt(document.getElementById('exp-amount').value);
            if(!title || !amount) return showAlert("Fill all fields");

            const newExp = {
                id: Date.now(),
                title: title,
                amount: amount,
                date: document.getElementById('date-picker').value
            };
            
            expenses.push(newExp);
            localStorage.setItem('myShopExpenses', JSON.stringify(expenses));
            
            document.getElementById('expense-modal').style.display = 'none';
            document.getElementById('exp-title').value = '';
            document.getElementById('exp-amount').value = '';
            
            renderDashboard();
            showAlert("Expense Added");
            
            // Queue Save
            addToSyncQueue("ADD_EXPENSE", [newExp.id, newExp.title, newExp.amount, newExp.date]);
        }

        function backupData() {
            const data = { products, history: salesHistory, expenses, settings: appSettings };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function restoreData() { document.getElementById('restore-file').click(); }
        
        function processRestore(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.products) localStorage.setItem('myShopProducts', JSON.stringify(d.products));
                    if(d.history) localStorage.setItem('myShopHistory', JSON.stringify(d.history));
                    if(d.expenses) localStorage.setItem('myShopExpenses', JSON.stringify(d.expenses));
                    if(d.settings) localStorage.setItem('myShopSettings', JSON.stringify(d.settings));
                    alert("Data Restored Successfully! Reloading...");
                    location.reload();
                } catch { alert("Invalid Backup File"); }
            };
            reader.readAsText(file);
        }

        // --- NEW: AUTO CALC COST ---
        function autoCalcCost() {
            const price = parseFloat(document.getElementById('new-price').value) || 0;
            const disc = parseFloat(document.getElementById('new-discount').value) || 0;
            if(price > 0 && disc > 0) {
                const cost = price - (price * (disc / 100));
                document.getElementById('new-cost').value = Math.round(cost);
            }
        }

        // --- RENDERERS ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = products.map((p,i) => {
                let profit = p.price - (p.cost || 0);
                let profitText = p.cost ? `<span style="font-size:10px; color:#64748b;">(Buy: ${p.cost}, Profit: <b style="${profit >= 0 ? 'color:#10b981' : 'color:#ef4444'}">${profit}</b>)</span>` : '';
                let packText = (p.packCount > 1 && p.packPrice > 0) ? `<br><span style="font-size:10px; color:#6366f1;">1 Pack = ${p.packCount} @ ${p.packPrice}</span>` : '';

                return `
                <div class="list-card">
                    <div>
                        <strong>${p.name}</strong><br>
                        <small>${p.category || 'General'}</small><br>
                        ${profitText}${packText}
                    </div>
                    <div style="text-align:right">
                        ${p.price.toLocaleString()} Ks<br>
                        <span class="${p.stock < 5 ? 'text-danger' : ''}">Stock: ${p.stock}</span>
                        <div style="margin-top:5px; display:flex; justify-content:flex-end; gap:5px;">
                            <button onclick="openProductModal(${i})" class="action-btn btn-edit"><svg class="icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button onclick="deleteProduct(${i})" class="action-btn btn-delete"><svg class="icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7c-1 0-2-1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openProductModal(index = -1) { 
            document.getElementById('edit-index').value = index; 
            
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.value = val;
            };

            if(index >= 0) { 
                const p = products[index]; 
                setVal('new-name', p.name); 
                setVal('new-price', p.price); 
                setVal('new-stock', p.stock); 
                setVal('new-code', p.code); 
                setVal('new-cost', p.cost || ''); 
                setVal('new-discount', '');
                setVal('new-pack-count', p.packCount || '');
                setVal('new-pack-price', p.packPrice || '');
                // Select category if exists
                if(p.category) {
                    const sel = document.getElementById('new-category');
                    for(let i=0; i<sel.options.length; i++){
                        if(sel.options[i].value === p.category) sel.selectedIndex = i;
                    }
                }
            } else { 
                setVal('new-name', ''); 
                setVal('new-price', ''); 
                setVal('new-stock', ''); 
                setVal('new-code', ''); 
                setVal('new-cost', ''); 
                setVal('new-discount', '');
                setVal('new-pack-count', '');
                setVal('new-pack-price', '');
            } 
            document.getElementById('product-modal').style.display = 'flex'; 
        }

        function saveProduct() { 
            const name = document.getElementById('new-name').value; 
            const price = parseInt(document.getElementById('new-price').value); 
            const stock = parseInt(document.getElementById('new-stock').value); 
            const code = document.getElementById('new-code').value; 
            const cat = document.getElementById('new-category').value; 
            
            const getInt = (id) => parseInt(document.getElementById(id)?.value) || 0;
            const cost = getInt('new-cost'); 
            const packCount = getInt('new-pack-count');
            const packPrice = getInt('new-pack-price');
            const idx = parseInt(document.getElementById('edit-index').value); 
            
            if(!name || !price) return showAlert("Missing fields"); 
            
            const obj = {name, price, stock, code, category: cat, cost: cost, packCount: packCount, packPrice: packPrice}; 
            
            if(idx === -1) products.push(obj); else products[idx] = obj; 
            
            localStorage.setItem('myShopProducts', JSON.stringify(products)); 
            document.getElementById('product-modal').style.display = 'none'; 
            showAlert("Saved"); 
            renderInventory(); renderPOS(); 
            
            // Queue Save
            addToSyncQueue("UPSERT_PRODUCT", [name, price, stock, code, cat, cost]);
        }

        function deleteProduct(i) { 
            showConfirm("Delete?", () => { 
                const p = products[i];
                const codeToDelete = p.code;
                products.splice(i,1); 
                localStorage.setItem('myShopProducts', JSON.stringify(products)); 
                renderInventory(); renderPOS(); 
                
                // Queue Save
                addToSyncQueue("DELETE_PRODUCT", codeToDelete);
            }); 
        }
        
        function calculateItemTotal(item) {
            const product = products.find(p => p.code === item.code);
            if (!product) return 0;
            let total = 0;
            if (product.packCount > 1 && product.packPrice > 0 && item.qty >= product.packCount) {
                const packs = Math.floor(item.qty / product.packCount);
                const loose = item.qty % product.packCount;
                total = (packs * product.packPrice) + (loose * product.price);
            } else {
                total = item.qty * product.price;
            }
            return total;
        }

        function updateCartUI() { 
            const list = document.getElementById('cart-items'); 
            list.innerHTML = ''; 
            let total = 0; 
            cart.forEach((item, idx) => { 
                const itemTotal = calculateItemTotal(item);
                total += itemTotal; 
                let wholesaleInfo = "";
                const product = products.find(p => p.code === item.code);
                if (product && product.packCount > 1 && product.packPrice > 0 && item.qty >= product.packCount) {
                     const packs = Math.floor(item.qty / product.packCount);
                     wholesaleInfo = `<br><span style="font-size:10px; color:#6366f1;">(${packs} Packs Applied)</span>`;
                }
                list.innerHTML += `<div class="cart-item"><div style="flex:1;"><div class="cart-item-name">${item.name}${wholesaleInfo}</div><div style="font-size:12px; color:#636e72;">${item.price.toLocaleString()} Ks</div></div><div style="display:flex; align-items:center; gap:8px; margin-right:10px;"><button onclick="changeCartQty(${idx}, -1)" style="width:28px; height:28px; border-radius:50%; border:1px solid #dfe6e9; background:white; color:#2d3436; font-weight:bold;">-</button><span style="font-weight:700; font-size:14px; min-width:20px; text-align:center;">${item.qty}</span><button onclick="changeCartQty(${idx}, 1)" style="width:28px; height:28px; border-radius:50%; border:none; background:var(--primary); color:white; font-weight:bold;">+</button></div><div style="font-weight:700; color:var(--dark); min-width:60px; text-align:right;">${itemTotal.toLocaleString()}</div><div class="cart-item-remove" onclick="removeFromCart(${idx})" style="margin-left:10px; font-size:18px;">‚úï</div></div>`; 
            }); 
            document.getElementById('total-display').innerText = total.toLocaleString() + " Ks"; 
            document.getElementById('mini-cart-total').innerText = total.toLocaleString() + " Ks"; 
        }

        function removeFromCart(index) { cart.splice(index, 1); updateCartUI(); renderPOS(); }
        function clearCartVerify() { if(cart.length>0) showConfirm("Clear cart?", function(){ cart=[]; updateCartUI(); renderPOS(); }); }
        
        function changeCartQty(index, change) { 
            const item = cart[index]; 
            const product = products.find(p => p.code === item.code); 
            if (change === 1) { 
                if (product && item.qty + 1 > product.stock) { return showAlert("No Stock!"); } 
                item.qty++; 
            } else { 
                if (item.qty > 1) { item.qty--; } 
                else { showConfirm("Remove?", () => { cart.splice(index, 1); updateCartUI(); renderPOS(); }); return; } 
            } 
            updateCartUI(); renderPOS(); 
        }
        
        function addToCart(code) { 
            const p = products.find(i => i.code === code); 
            if(p) { 
                if(p.stock <= 0) return showAlert("Out of Stock"); 
                let item = cart.find(i => i.code === code); 
                if(item && item.qty + 1 > p.stock) return showAlert("No Stock"); 
                if(item) item.qty++; else cart.push({...p, qty: 1}); 
                updateCartUI(); renderPOS(); 
                if (document.getElementById('scan-choice-modal')) document.getElementById('scan-choice-modal').style.display='none'; 
                if(document.getElementById('modal-input')) document.getElementById('modal-input').value = ''; 
            } else { 
                showConfirm("Add Item?", () => { 
                    if(document.getElementById('scan-choice-modal')) document.getElementById('scan-choice-modal').style.display='none'; 
                    openProductModal();
                    setTimeout(() => {
                         const el = document.getElementById('new-code');
                         if(el) { el.value = code; autoFillProductName(code); }
                    }, 100);
                }); 
            } 
        }
        function updateSync(s) { const c = document.getElementById('sync-status'); if(c) c.className = s; }
        
        // --- NEW: SYNC ENGINE (QUEUE BASED) ---
        function addToSyncQueue(action, data) {
            syncQueue.push({ action, data, id: Date.now() });
            localStorage.setItem('myShopQueue', JSON.stringify(syncQueue));
            updateSync('syncing'); // Show yellow immediately
            processQueue(); // Try sending immediately
        }

        async function processQueue() {
            if (SCRIPT_URL.includes("YOUR")) return;
            if (syncQueue.length === 0) { updateSync('synced'); return; }
            if (!navigator.onLine) { updateSync('error'); return; }

            const item = syncQueue[0]; // Peek first item

            try {
                // Try sending
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: item.action, data: item.data })
                });
                
                // On success (or accepted by server), remove from queue
                syncQueue.shift(); 
                localStorage.setItem('myShopQueue', JSON.stringify(syncQueue));
                
                // Process next item immediately if any
                if(syncQueue.length > 0) processQueue();
                else updateSync('synced');

            } catch (e) {
                console.error("Queue Error:", e);
                updateSync('error');
            }
        }

        // Retry Queue periodically
        setInterval(processQueue, 15000); // Check every 15 seconds

        async function fetchServerData(force) { 
            if(SCRIPT_URL.includes("YOUR")) return; 
            if(force) updateSync('syncing'); 
            try { 
                let res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime()); 
                let data = await res.json(); 
                
                // Only update if server has data
                if(data.products && data.products.length > 0) { 
                    products = data.products; 
                    localStorage.setItem('myShopProducts', JSON.stringify(products)); 
                } 
                if(data.history && data.history.length > 0) { 
                    salesHistory = data.history; 
                    localStorage.setItem('myShopHistory', JSON.stringify(salesHistory)); 
                } 
                if(data.expenses && data.expenses.length > 0) { 
                    expenses = data.expenses; 
                    localStorage.setItem('myShopExpenses', JSON.stringify(expenses)); 
                } 
                if(data.settings) { 
                    appSettings = {
                        name: data.settings.name || appSettings.name,
                        phone: data.settings.phone || appSettings.phone,
                        footer: data.settings.footer || appSettings.footer,
                        dateFormat: data.settings.dateFormat || appSettings.dateFormat
                    };
                    localStorage.setItem('myShopSettings', JSON.stringify(appSettings)); 
                    loadSettings(); 
                } 
                
                renderDashboard(); renderPOS(); renderInventory(); renderHistory(); 
                // Only mark synced if queue is empty
                if(syncQueue.length === 0) updateSync('synced'); 
            } catch (e) { if(force) updateSync('error'); } 
        }
        
        // Fetch on load (Download Only)
        fetchServerData(true);
        // Periodically fetch updates from others
        setInterval(() => fetchServerData(false), FETCH_INTERVAL);

        // ... [SCANNER & OTHER UTILS KEPT SAME] ...
        function openScanModal() { document.getElementById('scan-choice-modal').style.display='flex'; setTimeout(()=>document.getElementById('modal-input').focus(),100); }
        function closeModal(e) { if(e.target.id.includes('modal')) e.target.style.display='none'; }
        function handleManualInput() { addToCart(document.getElementById('modal-input').value); }
        function startScanner(t) { 
            document.getElementById('scan-choice-modal').style.display='none'; 
            document.getElementById('product-modal').style.display='none'; 
            document.getElementById('scanner-container').style.display='block'; 
            scanner = new Html5Qrcode("reader"); 
            scanner.start({facingMode:"environment"}, {fps:10}, (d) => {
                stopScanner().then(() => {
                    if(t==='cart') addToCart(d);
                    else {
                        openProductModal();
                        setTimeout(()=> {
                            const el = document.getElementById('new-code');
                            if(el) { el.value = d; autoFillProductName(d); }
                        }, 300);
                    }
                });
            }); 
        }
        function stopScanner() { if(scanner) return scanner.stop().then(() => document.getElementById('scanner-container').style.display='none'); document.getElementById('scanner-container').style.display='none'; return Promise.resolve(); }
        function closeReceipt() { document.getElementById('receipt-modal').style.display='none'; document.getElementById('cart-section').classList.remove('expanded'); }
        function showAlert(m) { document.getElementById('alert-message').innerText=m; document.getElementById('custom-alert').style.display='flex'; }
        function closeAlert() { document.getElementById('custom-alert').style.display='none'; }
        function showConfirm(m, f) { document.getElementById('confirm-message').innerText=m; document.getElementById('custom-confirm').style.display='flex'; document.getElementById('confirm-yes-btn').onclick=()=>{f();closeConfirm()}; }
        function closeConfirm() { document.getElementById('custom-confirm').style.display='none'; }
        
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id+'-screen').classList.add('active-screen'); document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active')); let btnId = id === 'dashboard' ? 'dash' : id === 'inventory' ? 'inv' : id === 'history' ? 'hist' : id === 'settings' ? 'set' : 'pos'; document.getElementById('btn-' + btnId).classList.add('active'); if(id==='dashboard') renderDashboard(); if(id==='history') renderHistory(); if(id==='settings') loadSettings(); }
        
        function openRefundModal(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return;
            const list = document.getElementById('refund-list');
            list.innerHTML = '';
            let parts = sale.items.split(", ");
            parts.forEach(p => {
                let [qtyStr, ...rest] = p.split("x ");
                let restStr = rest.join("x ");
                let name = restStr.replace(/\s\([^)]+\)$/, ""); 
                let qty = parseInt(qtyStr);
                const safeName = name.replace(/'/g, "\\\\'"); 
                list.innerHTML += `<div class="refund-item"><div><strong>${name}</strong><br><small>Qty: ${qty}</small></div><button class="refund-qty-btn" onclick="returnItem(${saleId}, '${safeName}')">Return 1</button></div>`;
            });
            document.getElementById('refund-modal').style.display = 'flex';
        }
        function closeRefundModal(e) { if (e.target.id === 'refund-modal') document.getElementById('refund-modal').style.display = 'none'; }
        
        function returnItem(saleId, itemName) { 
            const saleIndex = salesHistory.findIndex(s => s.id === saleId); 
            if (saleIndex === -1) return; 
            const sale = salesHistory[saleIndex]; 
            let product = products.find(p => p.name === itemName); 
            let itemPrice = 0; 
            if (product) { 
                product.stock++; 
                itemPrice = product.price; 
                // Sync Stock via Queue
                addToSyncQueue("UPSERT_PRODUCT", [product.name, product.price, product.stock, product.code, product.category, product.cost]);
            } 
            
            let parts = sale.items.split(", "); 
            let newParts = []; 
            let itemFound = false; 
            parts.forEach(p => { 
                let [qtyStr, ...rest] = p.split("x "); 
                let restStr = rest.join("x "); 
                let currentName = restStr.replace(/\s\([^)]+\)$/, ""); 
                let qty = parseInt(qtyStr); 
                if (currentName === itemName && !itemFound) { 
                    if (qty > 1) { 
                        let newTotal = (qty - 1) * itemPrice; 
                        newParts.push(`${qty - 1}x ${currentName} (${newTotal.toLocaleString()} Ks)`); 
                    } 
                    itemFound = true; 
                } else { newParts.push(p); } 
            }); 
            
            if (newParts.length === 0) { 
                // Fully Refunded - Delete Sale? Or Mark Refunded?
                // For simplicity, removing for now, but usually better to mark Status="Refunded"
                salesHistory.splice(saleIndex, 1); 
                document.getElementById('refund-modal').style.display = 'none'; 
                showAlert("Order fully refunded."); 
            } else { 
                sale.items = newParts.join(", "); 
                sale.total -= itemPrice; 
                if(sale.total < 0) sale.total = 0; 
                openRefundModal(saleId); 
            } 
            
            localStorage.setItem('myShopProducts', JSON.stringify(products)); 
            localStorage.setItem('myShopHistory', JSON.stringify(salesHistory)); 
            renderDashboard(); renderPOS(); renderInventory(); renderHistory(); 
            
            // Sync Sale Update via Queue
            if (newParts.length > 0) addToSyncQueue("UPDATE_SALE", [sale.id, sale.date, sale.total, sale.items, sale.paid, sale.debt, sale.status, sale.customer]);
        }

        function renderCategories() {
            const cats = ['All', ...new Set(products.map(p => p.category || 'General'))];
            document.getElementById('category-bar').innerHTML = cats.map(c => `<button class="cat-chip ${c===currentFilter?'active':''}" onclick="currentFilter='${c}';renderCategories();renderPOS()">${c}</button>`).join('');
        }

        function renderPOS() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            let salesCount = {};
            salesHistory.forEach(s => {
                if(s.items && typeof s.items === 'string') {
                    s.items.split(', ').forEach(item => {
                        let parts = item.split('x ');
                        if(parts.length > 1) {
                            let nameParts = parts[1].split(' (');
                            if(nameParts.length > 0) {
                                let name = nameParts[0];
                                let qty = parseInt(parts[0]);
                                if(!isNaN(qty)) salesCount[name] = (salesCount[name] || 0) + qty;
                            }
                        }
                    });
                }
            });

            let filteredProducts = products.filter(p => currentFilter==='All' || p.category===currentFilter);
            filteredProducts.sort((a, b) => {
                return (salesCount[b.name] || 0) - (salesCount[a.name] || 0);
            });

            filteredProducts.forEach((p, index) => {
                let stockClass = p.stock<=0 ? 'out-of-stock' : '';
                let hotBadge = (index < 3 && (salesCount[p.name] || 0) > 0) ? `<span class="hot-badge">üî• Hot</span>` : '';
                
                let cartItem = cart.find(c => c.code === p.code);
                let cartQty = cartItem ? cartItem.qty : 0;
                let displayStock = p.stock - cartQty;
                let cartBadge = cartQty > 0 ? `<span class="cart-qty-badge">${cartQty}</span>` : '';
                
                if(displayStock <= 0) stockClass = 'out-of-stock';

                list.innerHTML += `
                <div class="product-btn ${stockClass}" onclick="addToCart('${p.code}')">
                    ${hotBadge}
                    ${cartBadge}
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price.toLocaleString()}</div>
                    <div class="stock-badge">Stock: ${displayStock}</div>
                </div>`;
            });
        }

        renderCategories(); renderPOS(); renderInventory(); renderHistory(); loadSettings();
    </script>
</body>
</html>

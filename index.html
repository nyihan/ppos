<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Myanmar POS Pro v83</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- BASE STYLES --- */
        :root { 
            --primary: #2563eb; 
            --dark: #1e293b; 
            --text-gray: #64748b;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg-gradient); 
            height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden; user-select: none; 
            color: var(--dark);
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        /* --- ICONS & COMPONENTS --- */
        .icon { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 18px; height: 18px; stroke-width: 2.5; fill: none; stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; }

        .navbar { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            flex-shrink: 0; display: flex; z-index: 100; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); 
            border-top: 1px solid rgba(255,255,255,0.8);
            padding-bottom: env(safe-area-inset-bottom); height: 65px; 
        }
        .navbar button { 
            flex: 1; padding: 5px 0; border: none; background: transparent; 
            color: #94a3b8; font-size: 10px; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; 
        }
        .navbar button.active { color: var(--primary); }
        .navbar button.active svg { stroke: var(--primary); }

        .screen { display: none; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        .active-screen { display: flex; }

        .pos-header {
            flex-shrink: 0; padding: 10px 15px; z-index: 10;
            background: transparent; display: flex; align-items: center; gap: 10px; height: 60px;
        }
        .category-wrapper { flex: 1; overflow: hidden; display: flex; align-items: center; }
        .category-bar { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; width: 100%; }
        .cat-chip { 
            padding: 8px 16px; background: white; border-radius: 12px; 
            font-size: 13px; color: var(--text-gray); border: 1px solid #e2e8f0; 
            white-space: nowrap; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        .search-wrapper { flex: 1; display: none; align-items: center; gap: 10px; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        
        .glass-search { 
            flex: 1; display: flex; align-items: center; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border: 1px solid #e2e8f0; border-radius: 14px; padding: 8px 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .search-input { border: none; background: transparent; width: 100%; outline: none; font-size: 16px; color: var(--dark); font-weight: 600; padding: 0; margin: 0; }
        .search-btn-icon { 
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            color: var(--dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; flex-shrink: 0;
        }

        .product-area { flex: 1; overflow-y: auto; padding: 10px 15px; padding-bottom: 180px; }
        .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .product-btn { 
            background: white; padding: 10px; text-align: center; border-radius: 16px; 
            min-height: 100px; display: flex; flex-direction: column; justify-content: center; 
            position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
        }
        .product-btn:active { transform: scale(0.96); background: #f8fafc; }
        .product-name { font-weight: 700; font-size: 12px; color: var(--dark); margin-bottom: 4px; height: 32px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .product-price { color: var(--primary); font-weight: 800; font-size: 13px; }
        .stock-badge { font-size: 9px; color: var(--text-gray); background: #f1f5f9; padding: 3px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; font-weight: 600; }
        .out-of-stock { opacity: 0.6; }
        .out-of-stock .stock-badge { color: #ef4444; background: #fee2e2; }
        .hot-badge { position:absolute; top:-5px; right:-5px; background:#ff7675; color:white; font-size:9px; font-weight:bold; padding:2px 8px; border-radius:10px; box-shadow: 0 2px 5px rgba(255,118,117,0.4); z-index: 2; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0); } }

        .glass-fab {
            position: fixed; bottom: 90px; right: 20px;
            width: 56px; height: 56px; border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer; color: var(--primary);
        }
        .glass-fab:active { transform: scale(0.9); }

        .cart-section {
            position: fixed; bottom: 65px; left: 10px; width: calc(100% - 20px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            height: 60px; transition: height 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            z-index: 200; border: 1px solid rgba(255,255,255,0.6);
        }
        .cart-section.expanded { height: 75vh; bottom: 10px; border-radius: 24px; }
        .cart-header { height: 60px; padding: 0 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .cart-handle-bar { width: 40px; height: 5px; background: #dfe6e9; border-radius: 3px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .cart-summary-text { font-weight: 800; color: var(--dark); font-size: 15px; }
        .cart-total-badge { background: var(--dark); color: white; padding: 6px 12px; border-radius: 12px; font-weight: 700; font-size: 14px; }
        .cart-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
        .cart-section.expanded .cart-content { opacity: 1; }
        .cart-list { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border-radius: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; }
        .cart-footer { padding: 15px; background: white; border-top: 1px solid #f1f5f9; flex-shrink: 0; }
        .checkout-btn { width: 100%; padding: 16px; background: var(--dark); color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: 800; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 8px 20px rgba(30, 41, 59, 0.2); }

        .inventory-list { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; }
        .list-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        
        .add-item-fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 18px; background: var(--primary); color: white; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); display: flex; align-items: center; justify-content: center; z-index: 100; cursor: pointer; }

        .history-list { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .date-header { position: sticky; top: 0; background: #e2e8f0; color: #475569; padding: 6px 15px; border-radius: 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; z-index: 10; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .history-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; background: #e2e8f0; color: var(--text-gray); font-weight: 600; font-size: 13px; }
        .tab-btn.active { background: var(--primary); color: white; }

        .action-btn { width: 38px; height: 38px; border-radius: 12px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        .btn-edit { background: #e0e7ff; color: #4338ca; } 
        .btn-delete { background: #fee2e2; color: #ef4444; } 
        .btn-jpg { background: #dcfce7; color: #15803d; } 
        .btn-refund { background: #ffedd5; color: #c2410c; } 
        .btn-settle { background: #d1fae5; color: #047857; } 

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(30, 41, 59, 0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pay-input { width: 100%; padding: 15px; font-size: 28px; text-align: center; border: 2px solid #e2e8f0; border-radius: 16px; margin: 20px 0; font-weight: 800; color: var(--dark); outline: none; }
        .pay-input:focus { border-color: var(--primary); }
        .quick-cash { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .chip { padding: 10px 14px; background: #f1f5f9; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; color: var(--text-gray); }
        .alert-btn { width: 100%; padding: 14px; background: var(--dark); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background: #f1f5f9; color: var(--dark); }

        #sync-status { position: fixed; bottom: 80px; left: 20px; width: 14px; height: 14px; z-index: 6000; }
        .dot { width: 100%; height: 100%; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.3s; }
        .synced .dot { background: #10b981; } .syncing .dot { background: #f59e0b; animation: pulse 1s infinite; } .error .dot { background: #ef4444; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        .dash-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid white; color: var(--dark); padding: 25px; border-radius: 24px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); position: relative; overflow: hidden; }
        .sticky-header { padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #f1f5f9; flex-direction: column; display: flex; z-index: 20; }
        .warning-card { background:#fee2e2; border:1px solid #ef4444; color:#b91c1c; padding:15px; border-radius:16px; margin-bottom:15px; font-weight:bold; display:flex; align-items:center; gap:10px; font-size: 13px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.1); }

        .ai-btn { background: var(--ai-gradient); color: white; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); border:none; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .ai-btn-sm { padding: 8px 12px; font-size: 12px; margin-top: 0; width: auto; flex: 0; }
        #ai-response, #receipt-ai-message { margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; font-size: 14px; line-height: 1.6; border-left: 4px solid #8b5cf6; display: none; max-height: 50vh; overflow-y: auto; scrollbar-width: thin; }
        #receipt-ai-message { margin-bottom: 15px; margin-top: 0; font-style: italic; color: var(--text-gray); }

        #toast { visibility: hidden; min-width: 250px; background-color: #2d3436; color: #fff; text-align: center; border-radius: 30px; padding: 12px 20px; position: fixed; z-index: 6000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; font-weight: 600; opacity: 0; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        #receipt-export { position: absolute; left: -9999px; background: white; padding: 20px; width: 300px; font-family: monospace; }
        #scanner-container { display: none; position: fixed; inset: 0; background: black; z-index: 3000; }
        #reader { width: 100%; height: 100%; }
        .close-scanner-btn { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.2); padding: 15px 30px; border-radius: 30px; color: white; border: 1px solid rgba(255,255,255,0.3); font-weight: 700; z-index: 3001; backdrop-filter: blur(5px); }
        .refund-item { background: #f8fafc; border-radius: 12px; padding: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .refund-qty-btn { background: #ffe4e6; color: #e11d48; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; }

        input, select { width: 100%; padding: 14px; margin-bottom: 12px; box-sizing: border-box; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; background: white; appearance: none; outline: none; }
    </style>
</head>
<body>

    <div id="sync-status" class="synced"><div class="dot"></div></div>
    <div id="toast">Press back again to exit</div>

    <!-- EXPORT TEMPLATE -->
    <div id="receipt-export">
        <div style="text-align:center; font-weight:bold; font-size:18px; margin-bottom:10px;">MY SHOP</div>
        <div style="border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:10px;">Date: <span id="r-exp-date"></span><br>ID: <span id="r-exp-id"></span></div>
        <div id="r-exp-items"></div>
        <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px; text-align:right; font-weight:bold;">Total: <span id="r-exp-total"></span></div>
    </div>

    <!-- MAIN POS -->
    <div id="pos-screen" class="screen active-screen">
        <div class="pos-header">
            <div id="category-wrapper" class="category-wrapper">
                <div class="category-bar" id="category-bar"></div>
            </div>
            <div id="search-wrapper" class="search-wrapper" style="display:none;">
                <div class="glass-search">
                    <svg class="icon" style="color:var(--text-gray); margin-right:8px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="live-search" class="search-input" placeholder="Search Item..." oninput="handleSearch(this.value)">
                    <span onclick="document.getElementById('live-search').value=''; handleSearch('')" style="color:#94a3b8; cursor:pointer;">‚úï</span>
                </div>
                <button class="search-btn-icon" onclick="toggleSearch(false)">‚úï</button>
            </div>
            <button id="search-toggle-btn" class="search-btn-icon" onclick="toggleSearch(true)">
                <svg class="icon" style="width:20px; height:20px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
        </div>

        <div class="product-area"><div id="product-list" class="product-grid"></div></div>
        
        <!-- FAB - Direct Scan -->
        <div class="glass-fab" onclick="startScanner('cart')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="2"/></svg>
        </div>

        <div class="cart-section" id="cart-section">
            <div class="cart-header" onclick="toggleCart()">
                <div class="cart-handle-bar"></div>
                <div class="cart-summary-text" style="display:flex; align-items:center; gap:8px;">
                    <svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                    Current Sale
                </div>
                <div class="cart-total-badge" id="mini-cart-total">0 Ks</div>
            </div>
            
            <div class="cart-content">
                <div style="padding:10px 25px; display:flex; justify-content:flex-end;">
                    <div onclick="clearCartVerify()" style="color:#ef4444; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px; background: #fee2e2; padding: 8px 15px; border-radius: 12px;">
                        <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Clear
                    </div>
                </div>
                
                <div id="cart-items" class="cart-list"></div>
                
                <div class="cart-footer">
                    <button class="checkout-btn" onclick="openPaymentModal()">
                        <svg class="icon" style="color:white" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                        <span>CHARGE</span>
                        <span id="total-display">0 Ks</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin:0; color:var(--dark); font-size:24px;">Total Due</h2>
            <div style="font-size:36px; font-weight:800; color:var(--primary); margin:10px 0;" id="pay-total">0 Ks</div>
            <input type="number" id="cash-input" class="pay-input" placeholder="Enter Amount" autofocus>
            <div class="quick-cash">
                <div class="chip" onclick="fillCash(1000)">+1,000</div>
                <div class="chip" onclick="fillCash(5000)">+5,000</div>
                <div class="chip" onclick="fillCash(10000)">+10,000</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('payment-modal').style.display='none'" class="alert-btn btn-secondary">Cancel</button>
                <button onclick="processPayment()" class="alert-btn" style="background:var(--primary); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);">CONFIRM PAY</button>
            </div>
        </div>
    </div>

    <!-- DEBT MODAL -->
    <div id="debt-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#ef4444;">Partial Payment</h3>
            <div style="text-align:left; margin-bottom:15px; font-size:14px; color:#64748b;">
                <div>Total: <b id="debt-total"></b></div>
                <div>Paid: <b id="debt-paid"></b></div>
                <div style="color:#ef4444; margin-top:5px;">Remaining: <b id="debt-remain"></b></div>
            </div>
            <input type="text" id="debt-customer" placeholder="Customer Name" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; margin-bottom:15px;">
            <button onclick="confirmDebt()" class="alert-btn" style="background:#ef4444;">Save as Debt</button>
        </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div id="receipt-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="width:70px; height:70px; background:#dcfce7; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto;">
                <svg class="icon" style="color:#16a34a; width:36px; height:36px;" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <h2 style="margin:0; font-size:22px;">Success</h2>
            <div style="margin-top:25px; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Total</span><span id="r-total" style="font-weight:bold;">0</span></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><span>Cash</span><span id="r-cash" style="font-weight:bold;">0</span></div>
            </div>
            <div id="receipt-ai-message"></div>
            <div style="background:#f8fafc; padding:20px; border-radius:20px; border: 1px dashed #cbd5e1;">
                <div style="color:var(--text-gray); font-size:12px; font-weight:700; text-transform:uppercase;">Change</div>
                <div id="r-change" style="font-size:32px; color:var(--dark); font-weight:900;">0</div>
            </div>
            <button onclick="closeReceipt()" class="alert-btn">Next Sale</button>
        </div>
    </div>

    <!-- REFUND MODAL -->
    <div id="refund-modal" class="modal-overlay" onclick="closeRefundModal(event)">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--dark);">Refund Item</h3>
            <div id="refund-list" style="max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px;"></div>
            <button onclick="document.getElementById('refund-modal').style.display='none'" class="alert-btn btn-secondary">Close</button>
        </div>
    </div>

    <!-- INVENTORY SCREEN -->
    <div id="inventory-screen" class="screen">
        <div class="sticky-header"><h3 style="margin:0;">Inventory</h3></div>
        <div id="inventory-list" class="inventory-list"></div>
        <div class="add-item-fab" onclick="openProductModal()">
            <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </div>
    </div>

    <!-- ADD PRODUCT MODAL -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">Manage Item</h3>
            <input type="hidden" id="edit-index" value="-1">
            <div style="display:flex; gap:5px;">
                <select id="new-category" style="flex:1;"><option>General</option><option>Drinks</option><option>Food</option><option>Snacks</option></select>
                <button class="ai-btn ai-btn-sm" style="border-radius:12px;" onclick="suggestCategory()">‚ú®</button>
            </div>
            <input type="text" id="new-name" placeholder="Item Name">
            <div style="display:flex; gap:10px;">
                <input type="number" id="new-price" placeholder="Price" style="flex:2" oninput="autoCalcCost()">
                <input type="number" id="new-stock" placeholder="Stock" style="flex:1">
            </div>
            
            <!-- ADDED MISSING FIELDS -->
            <div style="display:flex; gap:10px; margin-top:10px;">
                 <input type="number" id="new-discount" placeholder="Disc %" style="flex:1" oninput="autoCalcCost()">
                 <input type="number" id="new-cost" placeholder="Buying Price (Cost)" style="flex:2">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="number" id="new-pack-count" placeholder="Pack Qty (e.g. 12)" style="flex:1">
                <input type="number" id="new-pack-price" placeholder="Pack Price" style="flex:1">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="new-code" placeholder="Barcode" style="flex:2">
                <button onclick="startScanner('new-code')" style="flex:1; background:#f1f5f9; border:none; border-radius:12px;">üì∑</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="document.getElementById('product-modal').style.display='none'" class="alert-btn btn-secondary">Cancel</button>
                <button onclick="saveProduct()" class="alert-btn" style="background:var(--dark);">Save</button>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="history-screen" class="screen">
        <div class="sticky-header" style="flex-direction:column; align-items:stretch; gap:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">History</h3>
                <button onclick="autoSyncDownload(true)" style="background:#eff6ff; color:var(--primary); border:none; padding:8px 12px; border-radius:8px; font-weight:700; font-size:12px;">Sync</button>
            </div>
            <div class="history-tabs">
                <button class="tab-btn active" onclick="filterHistory('all')" id="tab-all">All</button>
                <button class="tab-btn" onclick="filterHistory('paid')" id="tab-paid">Paid</button>
                <button class="tab-btn" onclick="filterHistory('unpaid')" id="tab-unpaid" style="color:#ef4444;">Unpaid</button>
            </div>
        </div>
        <div id="history-list" class="history-list"></div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="screen">
        <div class="sticky-header"><h3 style="margin:0;">Dashboard</h3></div>
        <div class="dash-container" id="dash-container">
            <!-- Cards will be injected here -->
            <button onclick="analyzeSalesWithAI()" class="alert-btn ai-btn">‚ú® AI Business Insight</button>
            <div id="ai-response"></div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="settings-screen" class="screen">
        <div class="sticky-header"><h3 style="margin:0;">Settings</h3></div>
        <div class="settings-container">
            <div class="setting-group">
                <label class="setting-label">Gemini API Key</label>
                <div style="font-size:12px; margin-bottom:5px; color:#10b981; font-weight:600;" id="key-status"></div>
                <input type="password" id="gemini-key" placeholder="Paste API Key here...">
                <button onclick="saveApiKey()" class="alert-btn" style="margin-top:0; padding:10px;">Save Key</button>
            </div>
            <div class="setting-group">
                <label class="setting-label">Database</label>
                <button onclick="if(confirm('Reset all?')) { localStorage.clear(); location.reload(); }" class="alert-btn" style="background:#fee2e2; color:#ef4444; margin-top:0;">Reset App Data</button>
            </div>
        </div>
    </div>

    <!-- COMMON MODALS -->
    <div id="custom-alert" class="modal-overlay" onclick="closeAlert()"><div class="modal-box"><h3 id="alert-title">Notice</h3><p id="alert-message" style="color:var(--text-gray)"></p><button onclick="closeAlert()" class="alert-btn">OK</button></div></div>
    <div id="custom-confirm" class="modal-overlay"><div class="modal-box"><h3>Confirm</h3><p id="confirm-message" style="color:var(--text-gray)"></p><div class="confirm-actions"><button onclick="closeConfirm()" class="alert-btn btn-secondary">No</button><button id="confirm-yes-btn" class="alert-btn" style="background:var(--primary)">Yes</button></div></div></div>
    
    <!-- SCANNER MODAL REMOVED - DIRECT ACCESS -->
    <div id="scan-choice-modal" class="modal-overlay" style="display:none;"></div> 

    <div id="scanner-container"><div id="reader"></div><button class="close-scanner-btn" onclick="stopScanner()">Close Camera</button></div>

    <div class="navbar">
        <button onclick="showScreen('dashboard')" id="btn-dash" class="active"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg><span>Dash</span></button>
        <button onclick="showScreen('pos')" id="btn-pos"><svg class="icon" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg><span>Sell</span></button>
        <button onclick="showScreen('inventory')" id="btn-inv"><svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg><span>Items</span></button>
        <button onclick="showScreen('history')" id="btn-hist"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>History</span></button>
        <button onclick="showScreen('settings')" id="btn-set"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Settings</span></button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX0aG1RfowaxXfHPNaPgxYSzQyL1wRnA78S0F3ZSpUiP-NA2CLIDBDuq1utof4DWX3/exec"; 
        const SYNC_INTERVAL = 60000;
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        let products = JSON.parse(localStorage.getItem('myShopProducts')) || [];
        let salesHistory = JSON.parse(localStorage.getItem('myShopHistory')) || [];
        let cart = [];
        let currentFilter = 'All';
        let historyFilter = 'all';
        let scanner;
        let tempDebtSale = {};

        function loadSettings() {
            const key = localStorage.getItem('geminiApiKey');
            const input = document.getElementById('gemini-key');
            const status = document.getElementById('key-status');
            if (key) { input.value = key; status.innerText = "Current Status: ‚úÖ Key Saved"; } 
            else { status.innerText = "Current Status: ‚ùå No Key"; }
        }
        function saveApiKey() { localStorage.setItem('geminiApiKey', document.getElementById('gemini-key').value.trim()); loadSettings(); showAlert("Saved!"); }

        // SEARCH LOGIC
        function toggleSearch(show) {
            const catWrapper = document.getElementById('category-wrapper');
            const searchWrapper = document.getElementById('search-wrapper');
            const searchBtn = document.getElementById('search-toggle-btn');
            const input = document.getElementById('live-search');

            if (show) {
                catWrapper.style.display = 'none';
                searchBtn.style.display = 'none';
                searchWrapper.style.display = 'flex';
                input.focus();
            } else {
                searchWrapper.style.display = 'none';
                catWrapper.style.display = 'flex';
                searchBtn.style.display = 'flex';
                input.value = '';
                handleSearch('');
            }
        }

        function handleSearch(query) {
            const term = query.toLowerCase();
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.code.includes(term)
            );

            // Calculate sales count for hot badge
            let salesCount = {};
            salesHistory.forEach(s => {
                if (s.items && typeof s.items === 'string') {
                    s.items.split(', ').forEach(item => {
                        let parts = item.split('x ');
                        if (parts.length > 1) {
                            let nameParts = parts[1].split(' (');
                            if (nameParts.length > 0) {
                                let name = nameParts[0];
                                let qty = parseInt(parts[0]);
                                if (!isNaN(qty)) {
                                    salesCount[name] = (salesCount[name] || 0) + qty;
                                }
                            }
                        }
                    });
                }
            });

            filtered.forEach(p => {
                let stockClass = p.stock<=0 ? 'out-of-stock' : '';
                let hotBadge = ((salesCount[p.name] || 0) > 5) ? `<span class="hot-badge">üî• Hot</span>` : '';
                list.innerHTML += `<div class="product-btn ${stockClass}" onclick="addToCart('${p.code}')">${hotBadge}<div class="product-name">${p.name}</div><div class="product-price">${p.price.toLocaleString()}</div><div class="stock-badge">Stock: ${p.stock}</div></div>`;
            });
        }

        // --- NEW AI FEATURES ---
        async function suggestCategory() {
            const name = document.getElementById('new-name').value;
            if(!name) return showAlert("Please enter item name first");
            const btn = document.querySelector('.ai-btn-sm');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥";
            
            try {
                const apiKey = localStorage.getItem('geminiApiKey');
                if(!apiKey) throw new Error("No API Key");
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Categorize "${name}" into one of: General, Drinks, Food, Snacks. Return ONLY the category name.` }] }] })
                });
                const data = await response.json();
                const cat = data.candidates?.[0]?.content?.parts?.[0]?.text.trim();
                
                const select = document.getElementById('new-category');
                for(let i=0; i<select.options.length; i++) {
                    if(select.options[i].value === cat) {
                        select.selectedIndex = i;
                        showAlert(`Auto-selected: ${cat}`);
                        break;
                    }
                }
            } catch (e) { console.error(e); showAlert("AI Categorize Failed"); }
            finally { btn.innerText = originalText; }
        }

        async function generateReceiptMessage(items) {
            const apiKey = localStorage.getItem('geminiApiKey');
            const msgDiv = document.getElementById('receipt-ai-message');
            msgDiv.style.display = 'none';
            if(!apiKey) return;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a very short, cute thank you message in Burmese for buying: ${items}. Max 1 sentence.` }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(text) {
                    msgDiv.innerHTML = `‚ú® ${text}`;
                    msgDiv.style.display = 'block';
                }
            } catch (e) { console.log("AI Receipt Msg Failed"); }
        }

        async function analyzeSalesWithAI() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if(!apiKey) return showAlert("Enter API Key in Settings.");

            const btn = document.querySelector('.ai-btn');
            const responseDiv = document.getElementById('ai-response');
            btn.innerText = "‚ú® Analyzing...";
            btn.disabled = true;
            responseDiv.style.display = 'none';

            const today = new Date().toLocaleDateString();
            const todaysSales = salesHistory.filter(s => s.date.includes(today));
            const total = todaysSales.reduce((a,b)=>a+b.total,0);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Analyze sales: ${total} MMK, ${todaysSales.length} txns. Suggest in Burmese.` }] }] })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    if (data.error.message && data.error.message.includes("User location is not supported")) {
                        throw new Error("AI service is not available in this region. Please try using a VPN. (·Äû·ÄÑ·Ä∑·Ä∫·Äí·Ä±·Äû·Äê·ÄΩ·ÄÑ·Ä∫ AI ·Äô·Äõ·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Åã VPN ·ÄÄ·Äª·Ä±·Ä¨·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Äû·ÄØ·Ä∂·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´)");
                    }
                    throw new Error(data.error.message || "API Error");
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                responseDiv.innerHTML = text.replace(/\n/g, '<br>') + "<br><br><small>‚úÖ Powered by Gemini AI</small>";
                responseDiv.style.display = 'block';

            } catch (error) {
                console.log("AI Failed:", error.message);
                let insight = `<strong>üì¢ OFFLINE INSIGHT (Local Mode)</strong><br><br>`;
                if (todaysSales.length === 0) {
                    insight += "·Äö·Äî·Ä±·Ä∑ ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã<br>·Äú·Ä∞·Äô·Äæ·ÄØ·ÄÄ·ÄΩ·Äî·Ä∫·Äõ·ÄÄ·Ä∫·Äê·ÄΩ·ÄÑ·Ä∫ ·Äï·Ä≠·ÄØ·Äô·Ä≠·ÄØ·ÄÄ·Äº·Ä±·Ä¨·Ä∫·ÄÑ·Äº·Ä¨·Äõ·Äî·Ä∫ ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·Äï·Ä´·Äû·Ää·Ä∫·Åã";
                } else {
                    let counts = {};
                    todaysSales.forEach(s => {
                        if (s.items && typeof s.items === 'string') {
                            s.items.split(', ').forEach(i => {
                                let parts = i.split('x ');
                                if (parts.length > 1) {
                                    let nameParts = parts[1].split(' (');
                                    if (nameParts.length > 0) {
                                        let name = nameParts[0];
                                        let qty = parseInt(parts[0]);
                                        if (!isNaN(qty)) {
                                            counts[name] = (counts[name] || 0) + qty;
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    let bestSeller = "N/A";
                    if (Object.keys(counts).length > 0) {
                        bestSeller = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                    }
                    
                    insight += `1. ·Äö·Äî·Ä±·Ä∑ ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÜ·ÄØ·Ä∂·Ä∏·Äô·Äæ·Ä¨ <b>${bestSeller}</b> ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã<br>2. ·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ <b>${total.toLocaleString()} Ks</b> ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äï·Ä´·Äû·Ää·Ä∫·Åã<br><br><small style='color:red'>* AI Error: ${error.message}</small>`;
                }
                responseDiv.innerHTML = insight;
                responseDiv.style.display = 'block';
            } finally {
                btn.innerText = "‚ú® AI Business Insight";
                btn.disabled = false;
            }
        }

        // BACK LOGIC
        let lastBackPressTime = 0;
        history.pushState(null, null, location.href); 
        window.onpopstate = function(event) {
            const now = new Date().getTime();
            const openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
            if (openModal) { openModal.style.display = 'none'; history.pushState(null, null, location.href); return; }
            const cart = document.getElementById('cart-section');
            if (cart.classList.contains('expanded')) { cart.classList.remove('expanded'); history.pushState(null, null, location.href); return; }
            if (document.getElementById('search-wrapper').style.display === 'flex') { toggleSearch(false); history.pushState(null, null, location.href); return; }
            const active = document.querySelector('.screen.active-screen');
            if (active && active.id !== 'pos-screen') { showScreen('pos'); history.pushState(null, null, location.href); return; }
            if (now - lastBackPressTime < 2000) { } else { lastBackPressTime = now; history.pushState(null, null, location.href); showToast("Press back again to exit"); }
        };
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // --- CORE FUNCTIONS ---
        function toggleCart() { document.getElementById('cart-section').classList.toggle('expanded'); }
        function openPaymentModal() { if(cart.length === 0) return showAlert("Empty"); document.getElementById('pay-total').innerText = cart.reduce((a, b) => a + calculateItemTotal(b), 0).toLocaleString() + " Ks"; document.getElementById('cash-input').value = ''; document.getElementById('payment-modal').style.display = 'flex'; setTimeout(() => document.getElementById('cash-input').focus(), 100); }
        function fillCash(a) { const i = document.getElementById('cash-input'); i.value = (parseInt(i.value)||0) + a; }
        
        function processPayment() {
            const total = cart.reduce((a, b) => a + calculateItemTotal(b), 0);
            const cashInput = document.getElementById('cash-input').value;
            const cash = cashInput === '' ? 0 : parseFloat(cashInput);

            if (cash < total) {
                tempDebtSale = { total: total, cash: cash, debt: total - cash };
                document.getElementById('payment-modal').style.display = 'none';
                document.getElementById('debt-total').innerText = total.toLocaleString();
                document.getElementById('debt-paid').innerText = cash.toLocaleString();
                document.getElementById('debt-remain').innerText = tempDebtSale.debt.toLocaleString();
                document.getElementById('debt-customer').value = "";
                document.getElementById('debt-modal').style.display = 'flex';
                document.getElementById('debt-customer').focus();
            } else {
                completeSale(total, cash, 0, 'Paid', '');
            }
        }

        function confirmDebt() {
            const customer = document.getElementById('debt-customer').value;
            if(!customer) return alert("Name Required");
            
            document.getElementById('debt-modal').style.display = 'none';
            completeSale(tempDebtSale.total, tempDebtSale.cash, tempDebtSale.debt, 'Unpaid', customer);
        }

        function completeSale(total, cash, debt, status, customer) {
            document.getElementById('payment-modal').style.display = 'none';
            cart.forEach(item => { let p = products.find(prod => prod.code === item.code); if(p) p.stock -= item.qty; });
            localStorage.setItem('myShopProducts', JSON.stringify(products));

            // Use consistent YYYY-MM-DD for date Key logic
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-CA') + ' ' + now.toLocaleTimeString(); 
            let itemStr = cart.map(i => `${i.qty}x ${i.name} (${calculateItemTotal(i).toLocaleString()})`).join(", ");
            
            salesHistory.unshift({ id: Date.now(), date: dateStr, total: total, items: itemStr, paid: cash, debt: debt, status: status, customer: customer });
            localStorage.setItem('myShopHistory', JSON.stringify(salesHistory));

            renderDashboard(); renderPOS(); renderInventory(); renderHistory(); autoSyncUpload();
            
            if(status === 'Paid') {
                const change = cash - total;
                document.getElementById('r-total').innerText = total.toLocaleString() + " Ks";
                document.getElementById('r-cash').innerText = cash.toLocaleString() + " Ks";
                document.getElementById('r-change').innerText = change.toLocaleString();
                document.getElementById('receipt-modal').style.display = 'flex';
                
                // AI Receipt Message Call
                generateReceiptMessage(itemStr);
            } else { showAlert("Debt Recorded"); }
            
            cart = []; updateCartUI();
            document.getElementById('cart-section').classList.remove('expanded');
        }

        function filterHistory(type) {
            historyFilter = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + type).classList.add('active');
            renderHistory();
        }

        function settleDebt(id) {
            showConfirm("Mark as Paid?", () => {
                const sale = salesHistory.find(s => s.id === id);
                if(sale) {
                    sale.status = 'Paid';
                    sale.paid = sale.total;
                    sale.debt = 0;
                    localStorage.setItem('myShopHistory', JSON.stringify(salesHistory));
                    renderHistory(); renderDashboard(); autoSyncUpload();
                }
            });
        }

        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            let filtered = salesHistory;
            if(historyFilter === 'paid') filtered = salesHistory.filter(s => s.status === 'Paid');
            if(historyFilter === 'unpaid') filtered = salesHistory.filter(s => s.status === 'Unpaid');
            let groups = {};
            const now = new Date();

            filtered.forEach(s => { let d = String(s.date).split(' ')[0]; if(!groups[d]) groups[d]=[]; groups[d].push(s); });
            
            for(let d in groups) {
                list.innerHTML += `<div class="date-header">${d}</div>` + groups[d].map(s => {
                    let isDebt = s.status === 'Unpaid';
                    let warningText = ''; let cardStyle = '';
                    if (isDebt) {
                        try {
                           let dateParts = String(s.date).split(' ')[0].split('/'); // Assuming MM/DD/YYYY
                           // Basic fallback if format differs
                           let saleDate = new Date(s.date); 
                           if(isNaN(saleDate.getTime())) saleDate = now; // Fallback to avoid crash

                           let diffDays = Math.ceil(Math.abs(now - saleDate) / (1000 * 60 * 60 * 24)); 
                            if(diffDays > 3) {
                                warningText = `<span style="color:red; font-size:11px; font-weight:bold; margin-left:5px;">‚ö†Ô∏è ${diffDays} Days Ago</span>`;
                                cardStyle = 'border-left: 5px solid #ef4444; background: #fff1f2;';
                            }
                        } catch(e) {}
                    }

                    let debtHtml = isDebt ? `<div style="margin-top:5px; color:#ef4444; font-weight:bold;">${s.customer}: ${s.debt.toLocaleString()} left ${warningText}</div>` : '';
                    let actionBtn = isDebt ? `<button onclick="settleDebt(${s.id})" class="action-btn btn-settle"><svg class="icon-sm" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg></button>` : `<button onclick="saveReceiptImage(${s.id})" class="action-btn btn-jpg"><svg class="icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></button>`;
                    return `<div class="list-card" style="${cardStyle}"><div style="flex:1"><div><strong>${s.total.toLocaleString()}</strong> <span class="${isDebt ? 'debt-tag' : 'paid-tag'}">${isDebt ? 'UNPAID' : 'PAID'}</span></div><small>${s.date.split(' ')[1] || s.date}</small><div style="font-size:12px;color:#666;">${s.items}</div>${debtHtml}</div><div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;">${actionBtn}<button onclick="openRefundModal(${s.id})" class="action-btn btn-refund"><svg class="icon-sm" viewBox="0 0 24 24"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg></button></div></div>`;
                }).join('');
            }
        }

        function renderDashboard() {
            let totalSales = 0; let totalDebt = 0; 
            let oldDebtCount = 0; 
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            const now = new Date();

            salesHistory.forEach(s => {
                // Robust date check
                let sDate = s.date.split(' ')[0];
                if(sDate === today) { 
                    if(s.status === 'Paid') totalSales += s.total; 
                    else totalSales += s.paid; 
                }
                if(s.status === 'Unpaid') {
                    totalDebt += s.debt;
                    let saleDate = new Date(sDate);
                    if(!isNaN(saleDate.getTime())) {
                         let diffDays = Math.ceil(Math.abs(now - saleDate) / (1000 * 60 * 60 * 24));
                         if(diffDays > 3) oldDebtCount++;
                    }
                }
            });

            let warningHtml = oldDebtCount > 0 ? `<div class="warning-card"><span>‚ö†Ô∏è</span> There are ${oldDebtCount} overdue debts (>3 days)</div>` : '';
            const container = document.getElementById('dash-container');
            container.innerHTML = `
                ${warningHtml}
                <div class="dash-card"><div class="dash-title">TOTAL SALES TODAY</div><div class="dash-value" id="dash-sales">${totalSales.toLocaleString()} Ks</div></div>
                <div class="dash-card" style="background: linear-gradient(135deg, #fee2e2, #fecaca); color:#b91c1c; border-color:#fca5a5;"><div class="dash-title" style="color:#991b1b;">OUTSTANDING DEBT</div><div class="dash-value" id="dash-debt">${totalDebt.toLocaleString()} Ks</div></div>
                <div class="dash-card" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);"><div class="dash-title">TRANSACTIONS</div><div class="dash-value" id="dash-orders">${salesHistory.filter(s => s.date.includes(today)).length}</div></div>
                <button onclick="analyzeSalesWithAI()" class="alert-btn ai-btn">‚ú® AI Business Insight</button>
                <div id="ai-response"></div>
            `;
        }

        // --- NEW: AUTO CALC COST ---
        function autoCalcCost() {
            const price = parseFloat(document.getElementById('new-price').value) || 0;
            const disc = parseFloat(document.getElementById('new-discount').value) || 0;
            if(price > 0 && disc > 0) {
                const cost = price - (price * (disc / 100));
                document.getElementById('new-cost').value = Math.round(cost);
            }
        }

        // --- RENDERERS ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = products.map((p,i) => {
                let profit = p.price - (p.cost || 0);
                let profitText = p.cost ? `<span style="font-size:10px; color:#64748b;">(Buy: ${p.cost}, Profit: <b style="${profit >= 0 ? 'color:#10b981' : 'color:#ef4444'}">${profit}</b>)</span>` : '';
                let packText = (p.packCount > 1 && p.packPrice > 0) ? `<br><span style="font-size:10px; color:#6366f1;">1 Pack = ${p.packCount} @ ${p.packPrice}</span>` : '';

                return `
                <div class="list-card">
                    <div>
                        <strong>${p.name}</strong><br>
                        <small>${p.category || 'General'}</small><br>
                        ${profitText}${packText}
                    </div>
                    <div style="text-align:right">
                        ${p.price.toLocaleString()} Ks<br>
                        <span class="${p.stock < 5 ? 'text-danger' : ''}">Stock: ${p.stock}</span>
                        <div style="margin-top:5px; display:flex; justify-content:flex-end; gap:5px;">
                            <button onclick="openProductModal(${i})" class="action-btn btn-edit"><svg class="icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button onclick="deleteProduct(${i})" class="action-btn btn-delete"><svg class="icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7c-1 0-2-1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openProductModal(index = -1) { 
            document.getElementById('edit-index').value = index; 
            
            // Safe helper to set value
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.value = val;
            };

            if(index >= 0) { 
                const p = products[index]; 
                setVal('new-name', p.name); 
                setVal('new-price', p.price); 
                setVal('new-stock', p.stock); 
                setVal('new-code', p.code); 
                setVal('new-cost', p.cost || ''); 
                setVal('new-discount', '');
                setVal('new-pack-count', p.packCount || '');
                setVal('new-pack-price', p.packPrice || '');
            } else { 
                setVal('new-name', ''); 
                setVal('new-price', ''); 
                setVal('new-stock', ''); 
                setVal('new-code', ''); 
                setVal('new-cost', ''); 
                setVal('new-discount', '');
                setVal('new-pack-count', '');
                setVal('new-pack-price', '');
            } 
            document.getElementById('product-modal').style.display = 'flex'; 
        }

        function saveProduct() { 
            const name = document.getElementById('new-name').value; 
            const price = parseInt(document.getElementById('new-price').value); 
            const stock = parseInt(document.getElementById('new-stock').value); 
            const code = document.getElementById('new-code').value; 
            const cat = document.getElementById('new-category').value; 
            
            // Safe parsing for optional fields
            const getInt = (id) => parseInt(document.getElementById(id)?.value) || 0;
            const cost = getInt('new-cost'); 
            const packCount = getInt('new-pack-count');
            const packPrice = getInt('new-pack-price');
            const idx = parseInt(document.getElementById('edit-index').value); 
            
            if(!name || !price) return showAlert("Missing fields"); 
            
            const obj = {name, price, stock, code, category: cat, cost: cost, packCount: packCount, packPrice: packPrice}; 
            
            if(idx === -1) products.push(obj); else products[idx] = obj; 
            
            localStorage.setItem('myShopProducts', JSON.stringify(products)); 
            document.getElementById('product-modal').style.display = 'none'; 
            showAlert("Saved"); 
            renderInventory(); renderPOS(); autoSyncUpload(); 
        }

        function deleteProduct(i) { showConfirm("Delete?", () => { products.splice(i,1); localStorage.setItem('myShopProducts', JSON.stringify(products)); renderInventory(); renderPOS(); autoSyncUpload(); }); }
        
        // --- UPDATED CART LOGIC (WHOLESALE) ---
        function calculateItemTotal(item) {
            const product = products.find(p => p.code === item.code);
            if (!product) return 0;
            
            let total = 0;
            if (product.packCount > 1 && product.packPrice > 0 && item.qty >= product.packCount) {
                const packs = Math.floor(item.qty / product.packCount);
                const loose = item.qty % product.packCount;
                total = (packs * product.packPrice) + (loose * product.price);
            } else {
                total = item.qty * product.price;
            }
            return total;
        }

        function updateCartUI() { 
            const list = document.getElementById('cart-items'); 
            list.innerHTML = ''; 
            let total = 0; 
            cart.forEach((item, idx) => { 
                const itemTotal = calculateItemTotal(item);
                total += itemTotal; 
                
                // Wholesale indicator text
                let wholesaleInfo = "";
                const product = products.find(p => p.code === item.code);
                if (product && product.packCount > 1 && product.packPrice > 0 && item.qty >= product.packCount) {
                     const packs = Math.floor(item.qty / product.packCount);
                     wholesaleInfo = `<br><span style="font-size:10px; color:#6366f1;">(${packs} Packs Applied)</span>`;
                }

                list.innerHTML += `<div class="cart-item"><div style="flex:1;"><div class="cart-item-name">${item.name}${wholesaleInfo}</div><div style="font-size:12px; color:#636e72;">${item.price.toLocaleString()} Ks</div></div><div style="display:flex; align-items:center; gap:8px; margin-right:10px;"><button onclick="changeCartQty(${idx}, -1)" style="width:28px; height:28px; border-radius:50%; border:1px solid #dfe6e9; background:white; color:#2d3436; font-weight:bold;">-</button><span style="font-weight:700; font-size:14px; min-width:20px; text-align:center;">${item.qty}</span><button onclick="changeCartQty(${idx}, 1)" style="width:28px; height:28px; border-radius:50%; border:none; background:var(--primary); color:white; font-weight:bold;">+</button></div><div style="font-weight:700; color:var(--dark); min-width:60px; text-align:right;">${itemTotal.toLocaleString()}</div><div class="cart-item-remove" onclick="removeFromCart(${idx})" style="margin-left:10px; font-size:18px;">‚úï</div></div>`; 
            }); 
            document.getElementById('total-display').innerText = total.toLocaleString() + " Ks"; 
            document.getElementById('mini-cart-total').innerText = total.toLocaleString() + " Ks"; 
        }

        function removeFromCart(index) { cart.splice(index, 1); updateCartUI(); }
        function clearCartVerify() { if(cart.length>0) showConfirm("Clear cart?", function(){ cart=[]; updateCartUI(); }); }
        function changeCartQty(index, change) { const item = cart[index]; const product = products.find(p => p.code === item.code); if (change === 1) { if (product && item.qty + 1 > product.stock) { return showAlert("No Stock!"); } item.qty++; } else { if (item.qty > 1) { item.qty--; } else { showConfirm("Remove?", () => { cart.splice(index, 1); updateCartUI(); }); return; } } updateCartUI(); }
        function addToCart(code) { const p = products.find(i => i.code === code); if(p) { if(p.stock <= 0) return showAlert("Out of Stock"); let item = cart.find(i => i.code === code); if(item && item.qty + 1 > p.stock) return showAlert("No Stock"); if(item) item.qty++; else cart.push({...p, qty: 1}); updateCartUI(); document.getElementById('scan-choice-modal').style.display='none'; document.getElementById('modal-input').value = ''; } else { showConfirm("Add Item?", () => { document.getElementById('scan-choice-modal').style.display='none'; document.getElementById('modal-input').value = ''; document.getElementById('new-code').value = code; openProductModal(); }); } }
        function updateSync(s) { const c = document.getElementById('sync-status'); if(c) c.className = s; }
        async function autoSyncUpload() { if(SCRIPT_URL.includes("YOUR")) return; updateSync('syncing'); try { await fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({products, history:salesHistory})}); updateSync('synced'); } catch { updateSync('error'); } }
        async function autoSyncDownload(force) { if(SCRIPT_URL.includes("YOUR")) return; if(force) updateSync('syncing'); try { let res = await fetch(SCRIPT_URL); let data = await res.json(); if(data.products) { products = data.products; localStorage.setItem('myShopProducts', JSON.stringify(products)); } if(data.history) { salesHistory = data.history; localStorage.setItem('myShopHistory', JSON.stringify(salesHistory)); } renderDashboard(); renderPOS(); renderInventory(); renderHistory(); updateSync('synced'); } catch { if(force) updateSync('error'); } }
        setInterval(autoSyncDownload, SYNC_INTERVAL);
        function openScanModal() { document.getElementById('scan-choice-modal').style.display='flex'; setTimeout(()=>document.getElementById('modal-input').focus(),100); }
        function closeModal(e) { if(e.target.id.includes('modal')) e.target.style.display='none'; }
        function handleManualInput() { addToCart(document.getElementById('modal-input').value); }
        function startScanner(t) { document.getElementById('scan-choice-modal').style.display='none'; document.getElementById('product-modal').style.display='none'; document.getElementById('scanner-container').style.display='block'; scanner=new Html5Qrcode("reader"); scanner.start({facingMode:"environment"},{fps:10},d=>{stopScanner();if(t==='new-code'){document.getElementById('new-code').value=d; openProductModal();}else addToCart(d);}); }
        function stopScanner() { if(scanner) scanner.stop().then(()=>{document.getElementById('scanner-container').style.display='none';}); }
        function closeReceipt() { document.getElementById('receipt-modal').style.display='none'; document.getElementById('cart-section').classList.remove('expanded'); }
        function showAlert(m) { document.getElementById('alert-message').innerText=m; document.getElementById('custom-alert').style.display='flex'; }
        function closeAlert() { document.getElementById('custom-alert').style.display='none'; }
        function showConfirm(m, f) { document.getElementById('confirm-message').innerText=m; document.getElementById('custom-confirm').style.display='flex'; document.getElementById('confirm-yes-btn').onclick=()=>{f();closeConfirm()}; }
        function closeConfirm() { document.getElementById('custom-confirm').style.display='none'; }
        function saveReceiptImage(id) { const sale = salesHistory.find(s => s.id === id); if (!sale) return; document.getElementById('r-exp-date').innerText = sale.date; document.getElementById('r-exp-id').innerText = "#" + sale.id.toString().slice(-6); document.getElementById('r-exp-total').innerText = sale.total.toLocaleString() + " Ks"; let itemsHtml = ""; sale.items.split(", ").forEach(p => { itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${p}</span></div>`; }); document.getElementById('r-exp-items').innerHTML = itemsHtml; const element = document.getElementById('receipt-export'); element.style.left = "0"; element.style.top = "0"; element.style.zIndex = "9999"; html2canvas(element).then(canvas => { const link = document.createElement('a'); link.download = `receipt_${sale.id}.jpg`; link.href = canvas.toDataURL("image/jpeg"); link.click(); element.style.left = "-9999px"; }); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id+'-screen').classList.add('active-screen'); document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active')); let btnId = id === 'dashboard' ? 'dash' : id === 'inventory' ? 'inv' : id === 'history' ? 'hist' : id === 'settings' ? 'set' : 'pos'; document.getElementById('btn-' + btnId).classList.add('active'); if(id==='dashboard') renderDashboard(); if(id==='history') renderHistory(); if(id==='settings') loadSettings(); }
        function openRefundModal(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return;
            const list = document.getElementById('refund-list');
            list.innerHTML = '';
            let parts = sale.items.split(", ");
            parts.forEach(p => {
                let [qtyStr, ...rest] = p.split("x ");
                let restStr = rest.join("x ");
                let name = restStr.replace(/\s\([^)]+\)$/, ""); 
                let qty = parseInt(qtyStr);
                const safeName = name.replace(/'/g, "\\\\'"); 
                list.innerHTML += `<div class="refund-item"><div><strong>${name}</strong><br><small>Qty: ${qty}</small></div><button class="refund-qty-btn" onclick="returnItem(${saleId}, '${safeName}')">Return 1</button></div>`;
            });
            document.getElementById('refund-modal').style.display = 'flex';
        }
        function closeRefundModal(e) { if (e.target.id === 'refund-modal') document.getElementById('refund-modal').style.display = 'none'; }
        function returnItem(saleId, itemName) { /* ... Same Refund Logic ... */ const saleIndex = salesHistory.findIndex(s => s.id === saleId); if (saleIndex === -1) return; const sale = salesHistory[saleIndex]; let product = products.find(p => p.name === itemName); let itemPrice = 0; if (product) { product.stock++; itemPrice = product.price; } let parts = sale.items.split(", "); let newParts = []; let itemFound = false; parts.forEach(p => { let [qtyStr, ...rest] = p.split("x "); let restStr = rest.join("x "); let currentName = restStr.replace(/\s\([^)]+\)$/, ""); let qty = parseInt(qtyStr); if (currentName === itemName && !itemFound) { if (qty > 1) { let newTotal = (qty - 1) * itemPrice; newParts.push(`${qty - 1}x ${currentName} (${newTotal.toLocaleString()} Ks)`); } itemFound = true; } else { newParts.push(p); } }); if (newParts.length === 0) { salesHistory.splice(saleIndex, 1); document.getElementById('refund-modal').style.display = 'none'; showAlert("Order fully refunded."); } else { sale.items = newParts.join(", "); sale.total -= itemPrice; if(sale.total < 0) sale.total = 0; openRefundModal(saleId); } localStorage.setItem('myShopProducts', JSON.stringify(products)); localStorage.setItem('myShopHistory', JSON.stringify(salesHistory)); renderDashboard(); renderPOS(); renderInventory(); renderHistory(); autoSyncUpload(); }

        function renderCategories() {
            const cats = ['All', ...new Set(products.map(p => p.category || 'General'))];
            document.getElementById('category-bar').innerHTML = cats.map(c => `<button class="cat-chip ${c===currentFilter?'active':''}" onclick="currentFilter='${c}';renderCategories();renderPOS()">${c}</button>`).join('');
        }

        function renderPOS() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            // 1. Calculate Sales Counts
            let salesCount = {};
            salesHistory.forEach(s => {
                if(s.items && typeof s.items === 'string') {
                    s.items.split(', ').forEach(item => {
                        let parts = item.split('x ');
                        if(parts.length > 1) {
                            let nameParts = parts[1].split(' (');
                            if(nameParts.length > 0) {
                                let name = nameParts[0];
                                let qty = parseInt(parts[0]);
                                if(!isNaN(qty)) salesCount[name] = (salesCount[name] || 0) + qty;
                            }
                        }
                    });
                }
            });

            // 2. Filter & Sort by Sales (High to Low)
            let filteredProducts = products.filter(p => currentFilter==='All' || p.category===currentFilter);
            filteredProducts.sort((a, b) => {
                return (salesCount[b.name] || 0) - (salesCount[a.name] || 0);
            });

            // 3. Render
            filteredProducts.forEach((p, index) => {
                let stockClass = p.stock<=0 ? 'out-of-stock' : '';
                // Top 3 items get HOT badge
                let hotBadge = (index < 3 && (salesCount[p.name] || 0) > 0) ? `<span class="hot-badge">üî• Hot</span>` : '';
                
                list.innerHTML += `
                <div class="product-btn ${stockClass}" onclick="addToCart('${p.code}')">
                    ${hotBadge}
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${p.price.toLocaleString()}</div>
                    <div class="stock-badge">Stock: ${p.stock}</div>
                </div>`;
            });
        }

        renderCategories(); renderPOS(); renderInventory(); renderHistory(); autoSyncDownload(); loadSettings();
    </script>
</body>
</html>
